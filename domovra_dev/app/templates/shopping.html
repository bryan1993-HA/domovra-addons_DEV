{% extends "base.html" %}
{% block title %}Domovra ‚Äî Listes d‚Äôachats{% endblock %}

{% block content %}
<div class="wrap" data-page="shopping">

  <!-- Header collant avec chips des listes -->
  <header class="page-header">
    <h1>Domovra ‚Äî <span class="muted">Listes d‚Äôachats</span></h1>

    <div class="chips scroll-x" aria-label="Listes">
      {% for L in LISTS %}
      <a class="chip {% if L.id == ACTIVE_LIST_ID %}active{% endif %}" href="{{ BASE }}/shopping?list={{ L.id }}">
        {{ L.emoji or 'üõí' }} {{ L.name }}
        <span class="badge">{{ L.to_buy or 0 }}</span>
      </a>
      {% endfor %}
      <button class="chip action" data-open="#dlg-new-list">‚ûï Nouvelle</button>
    </div>
  </header>

  <!-- Barre de filtre -->
  <div class="toolbar">
    <div class="left">
      <div class="seg" role="tablist" aria-label="Filtre">
        <a class="seg-btn {% if STATUS == 'all' %}active{% endif %}"
          href="{{ BASE }}/shopping?list={{ ACTIVE_LIST_ID }}&status=all">Tous</a>
        <a class="seg-btn {% if STATUS == 'todo' %}active{% endif %}"
          href="{{ BASE }}/shopping?list={{ ACTIVE_LIST_ID }}&status=todo">√Ä acheter</a>
        <a class="seg-btn {% if STATUS == 'done' %}active{% endif %}"
          href="{{ BASE }}/shopping?list={{ ACTIVE_LIST_ID }}&status=done">Achet√©s</a>
      </div>
    </div>
    <div class="right">
      <form id="frm-rename-list" method="post" action="{{ BASE }}/shopping/list/rename" class="inline">
        <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
        <input type="text" name="name" placeholder="Renommer la liste‚Ä¶" class="input sm">
        <button class="btn sm">Renommer</button>
      </form>
      <form method="post" action="{{ BASE }}/shopping/list/delete" class="inline"
        onsubmit="return confirm('Supprimer la liste ? Les items seront supprim√©s.');">
        <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
        <button class="btn sm danger">Supprimer</button>
      </form>
    </div>
  </div>

  <!-- Carte Ajout rapide -->
  <section class="abox v2 add-form">
    <header class="abox-h"><strong>Ajouter un produit</strong></header>
    <div class="abox-c">
      <form method="post" action="{{ BASE }}/shopping/item/add" class="grid add-grid">
        <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">

        <div>
          <label class="label">Produit</label>
          <input list="products" name="product_id" class="input" inputmode="numeric"
            placeholder="ID produit (auto-compl√©tion ci-dessous)" required>
          <small class="hint">Commence √† taper le nom ci-dessous, puis saisis l‚Äô<strong>ID</strong> retourn√©.</small>
          <datalist id="products">
            {% for P in PRODUCTS %}
            <option value="{{ P.id }}">{{ P.name }}{% if P.brand %} ‚Äî {{ P.brand }}{% endif %}{% if P.unit %} ({{ P.unit
              }}){% endif %}{% if P.barcode %} [{{ P.barcode }}]{% endif %}</option>
            {% endfor %}
          </datalist>
        </div>

        <div>
          <label class="label">Quantit√©</label>
          <input type="number" name="qty" value="1" step="0.01" min="0" class="input" required>
        </div>

        <div>
          <label class="label">Unit√© (optionnel)</label>
          <input type="text" name="unit" class="input" placeholder="ex: kg, L, pi√®ce‚Ä¶">
          <small class="hint">Par d√©faut : unit√© du produit.</small>
        </div>

        <div class="span2">
          <label class="label">Note (facultatif)</label>
          <input type="text" name="note" class="input" placeholder="Pr√©cision (marque, format‚Ä¶)">
        </div>

        <div class="actions">
          <button class="btn">Ajouter</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Liste des items -->
  <section class="list-block">
    {% if ITEMS|length == 0 %}
    <p class="muted">Aucun item dans cette vue.</p>
    {% else %}
    <div class="table-wrap hide-mobile">
      <table class="table">
        <colgroup>
          <col style="width:44%">
          <col style="width:12%">
          <col style="width:20%">
          <col style="width:24%">
        </colgroup>
        <thead>
          <tr>
            <th>Produit</th>
            <th>Qt√©</th>
            <th>Note</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for I in ITEMS %}
          <tr class="{% if I.is_checked %}checked{% endif %}">
            <td>
              <div class="mono">{{ I.product_name }}</div>
              {% if I.product_brand %}<small class="muted">{{ I.product_brand }}</small>{% endif %}
            </td>
            <td>{{ I.qty }} {% if I.unit %}<span class="muted">{{ I.unit }}</span>{% else %}<span class="muted">{{
                I.product_unit or '' }}</span>{% endif %}</td>
            <td class="mono">{{ I.note or '' }}</td>
            <td class="right">
              <form method="post" action="{{ BASE }}/shopping/item/toggle" class="inline">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn sm {% if I.is_checked %}secondary{% else %}ok{% endif %}">
                  {% if I.is_checked %}D√©cocher{% else %}Cocher{% endif %}
                </button>
              </form>
              <form method="post" action="{{ BASE }}/shopping/item/delete" class="inline"
                onsubmit="return confirm('Supprimer cet item ?');">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn sm danger">Suppr.</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile cards -->
    <div class="cards show-mobile">
      {% for I in ITEMS %}
      <article class="card {% if I.is_checked %}checked{% endif %}">
        <header class="card-h">
          <strong>{{ I.product_name }}</strong>
          {% if I.product_brand %}<span class="muted"> ‚Äî {{ I.product_brand }}</span>{% endif %}
        </header>
        <div class="card-c">
          <div class="kv">
            <div><span class="k">Qt√©</span><span class="v">{{ I.qty }} {{ I.unit or I.product_unit or '' }}</span></div>
            {% if I.note %}<div><span class="k">Note</span><span class="v mono">{{ I.note }}</span></div>{% endif %}
          </div>
        </div>
        <footer class="card-f right">
          <form method="post" action="{{ BASE }}/shopping/item/toggle" class="inline">
            <input type="hidden" name="item_id" value="{{ I.id }}">
            <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
            <button class="btn xs {% if I.is_checked %}secondary{% else %}ok{% endif %}">
              {% if I.is_checked %}D√©cocher{% else %}Cocher{% endif %}
            </button>
          </form>
          <form method="post" action="{{ BASE }}/shopping/item/delete" class="inline"
            onsubmit="return confirm('Supprimer cet item ?');">
            <input type="hidden" name="item_id" value="{{ I.id }}">
            <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
            <button class="btn xs danger">Suppr.</button>
          </form>
        </footer>
      </article>
      {% endfor %}
    </div>
    {% endif %}
  </section>

  <!-- Dialog nouvelle liste -->
  <dialog id="dlg-new-list" class="modal">
    <form method="post" action="{{ BASE }}/shopping/list/create" class="modal-body">
      <header><strong>Nouvelle liste</strong></header>
      <div class="modal-content grid">
        <div>
          <label class="label">Nom</label>
          <input type="text" name="name" class="input" placeholder="Courses Semaine" required>
        </div>
        <div>
          <label class="label">Emoji (optionnel)</label>
          <input type="text" name="emoji" class="input" placeholder="üõí">
        </div>
      </div>
      <footer class="modal-actions right">
        <button type="button" class="btn secondary" data-close="#dlg-new-list">Annuler</button>
        <button class="btn">Cr√©er</button>
      </footer>
    </form>
  </dialog>

</div>
{% endblock %}

{% block scripts %}
<script>
  // Ouvrir/fermer modales (l√©ger)
  document.querySelectorAll("[data-open]").forEach(btn => {
    btn.addEventListener("click", e => {
      const dlg = document.querySelector(btn.getAttribute("data-open"));
      dlg && dlg.showModal();
    });
  });
  document.querySelectorAll("[data-close]").forEach(btn => {
    btn.addEventListener("click", e => {
      const dlg = document.querySelector(btn.getAttribute("data-close"));
      dlg && dlg.close();
    });
  });

  // Toasts bas√©s sur ?toast=
  (function () {
    const u = new URL(window.location);
    const t = u.searchParams.get("toast");
    if (!t) return;
    const map = {
      added_list: ["Liste cr√©√©e.", "ok"],
      renamed_list: ["Liste renomm√©e.", "ok"],
      deleted_list: ["Liste supprim√©e.", "warn"],
      added_item: ["Produit ajout√© √† la liste.", "ok"],
      toggled: ["Statut mis √† jour.", "ok"],
      deleted_item: ["Item supprim√©.", "warn"],
      error: ["Une erreur est survenue.", "error"]
    };
    const payload = map[t] || null;
    if (payload && window.showToast) {
      window.showToast(payload[0], payload[1]);
    }
    // Nettoie l‚ÄôURL
    u.searchParams.delete("toast");
    window.history.replaceState({}, "", u);
  })();
</script>
{% endblock %}