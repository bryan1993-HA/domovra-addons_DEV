{% extends "base.html" %}
{% block title %}Domovra â€” Listes dâ€™achats{% endblock %}

{% block content %}
<div class="wrap" data-page="shopping">

  <!-- Header collant avec chips des listes -->
  <header class="page-header">
    <h1>Domovra â€” <span class="muted">Listes dâ€™achats</span></h1>

    <div class="chips scroll-x" aria-label="Listes">
      {% for L in LISTS %}
      <a class="chip {% if L.id == ACTIVE_LIST_ID %}active{% endif %}" href="{{ BASE }}/shopping?list={{ L.id }}">
        {{ L.emoji or 'ðŸ›’' }} {{ L.name }}
        <span class="badge">{{ L.to_buy or 0 }}</span>
      </a>
      {% endfor %}
      <button class="chip action" data-open="#dlg-new-list">âž• Nouvelle</button>
    </div>
  </header>

  <!-- Barre de filtre -->
  <div class="toolbar">
    <div class="left">
      <div class="seg" role="tablist" aria-label="Filtre">
        <a class="seg-btn {% if STATUS == 'all' %}active{% endif %}"
          href="{{ BASE }}/shopping?list={{ ACTIVE_LIST_ID }}&status=all">Tous</a>
        <a class="seg-btn {% if STATUS == 'todo' %}active{% endif %}"
          href="{{ BASE }}/shopping?list={{ ACTIVE_LIST_ID }}&status=todo">Ã€ acheter</a>
        <a class="seg-btn {% if STATUS == 'done' %}active{% endif %}"
          href="{{ BASE }}/shopping?list={{ ACTIVE_LIST_ID }}&status=done">AchetÃ©s</a>
      </div>
    </div>
    <div class="right">
      <form id="frm-rename-list" method="post" action="{{ BASE }}/shopping/list/rename" class="inline">
        <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
        <input type="text" name="name" placeholder="Renommer la listeâ€¦" class="input sm">
        <button class="btn sm">Renommer</button>
      </form>
      <form method="post" action="{{ BASE }}/shopping/list/delete" class="inline"
        onsubmit="return confirm('Supprimer la liste ? Les items seront supprimÃ©s.');">
        <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
        <button class="btn sm danger">Supprimer</button>
      </form>
    </div>
  </div>

  <!-- Carte Ajout rapide -->
  <section class="abox v2 add-form">
    <header class="abox-h"><strong>Ajouter un produit</strong></header>
    <div class="abox-c">
      <form method="post" action="{{ BASE }}/shopping/item/add" class="grid add-grid">
        <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">

        <div>
          <label class="label">Produit</label>
          <input list="products" name="product_id_display" class="input" placeholder="Rechercher un produitâ€¦" required>
          <input type="hidden" name="product_id" id="product_id_hidden">
          <small class="hint">
            Choisis une suggestion. Si absent :
            <a href="{{ BASE }}/products?toast=add_new" class="link">crÃ©er un produit</a>.
          </small>
          <datalist id="products">
            {% for P in PRODUCTS %}
            <option
              value="{{ P.id }} â€” {{ P.name }}{% if P.unit %} ({{ P.unit }}){% endif %}{% if P.barcode %} [{{ P.barcode }}]{% endif %}">
            </option>
            {% endfor %}
          </datalist>
        </div>


        <div>
          <label class="label">QuantitÃ©</label>
          <input type="number" name="qty" value="1" step="0.01" min="0" class="input" required>
        </div>

        <div>
          <label class="label">UnitÃ© (optionnel)</label>
          <input type="text" name="unit" class="input" placeholder="ex: kg, L, piÃ¨ceâ€¦">
          <small class="hint">Par dÃ©faut : unitÃ© du produit.</small>
        </div>

        <div class="span2">
          <label class="label">Note (facultatif)</label>
          <input type="text" name="note" class="input" placeholder="PrÃ©cision (marque, formatâ€¦)">
        </div>

        <div class="actions">
          <button class="btn">Ajouter</button>
        </div>
      </form>
    </div>
  </section>

  <!-- Liste des items -->
  <section class="list-block">
    {% if ITEMS|length == 0 %}
    <p class="muted">Aucun item dans cette vue.</p>
    {% else %}
    <!-- Desktop table -->
    <div class="table-wrap hide-mobile">
      <table class="table">
        <colgroup>
          <col style="width:36%">
          <col style="width:10%">
          <col style="width:22%">
          <col style="width:32%">
        </colgroup>
        <thead>
          <tr>
            <th>Produit</th>
            <th>QtÃ©</th>
            <th>Note</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for I in ITEMS %}
          <tr class="{% if I.is_checked %}checked{% endif %}">
            <td>
              <div class="mono">{{ I.product_name }}</div>
              {% if I.product_unit %}<small class="muted">UnitÃ©: {{ I.product_unit }}</small>{% endif %}
              {% if I.store %}<div><small class="muted">Magasin: {{ I.store }}</small></div>{% endif %}
              {% if I.shelf_unit_price is not none %}
              <div><small class="muted">Prix rayon: {{ '%.2f'|format(I.shelf_unit_price) }} â‚¬ / {{ I.unit or
                  I.product_unit or '' }}</small></div>
              {% endif %}
              {% if I.ticket_unit_price is not none %}
              <div><small class="muted">Ticket: {{ '%.2f'|format(I.ticket_unit_price) }} â‚¬ (Î” {{
                  '%.2f'|format(I.price_delta or (I.ticket_unit_price - (I.shelf_unit_price or 0))) }} â‚¬)</small></div>
              {% endif %}
            </td>
            <td>{{ I.qty }} {% if I.unit %}<span class="muted">{{ I.unit }}</span>{% else %}<span class="muted">{{
                I.product_unit or '' }}</span>{% endif %}</td>
            <td class="mono">{{ I.note or '' }}</td>
            <td class="right">
              {% if not I.is_checked %}
              <!-- Bouton Acheter -->
              <button class="btn sm ok" data-buy="#buy-{{ I.id }}">Acheter</button>
              <!-- Toggle simple -->
              <form method="post" action="{{ BASE }}/shopping/item/toggle" class="inline">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn sm secondary">Cocher</button>
              </form>
              {% else %}
              <form method="post" action="{{ BASE }}/shopping/item/toggle" class="inline">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn sm secondary">DÃ©cocher</button>
              </form>
              {% endif %}
              <form method="post" action="{{ BASE }}/shopping/item/delete" class="inline"
                onsubmit="return confirm('Supprimer cet item ?');">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn sm danger">Suppr.</button>
              </form>
            </td>
          </tr>

          {% if not I.is_checked %}
          <!-- Panneau Acheter (inline, cachÃ© par dÃ©faut) -->
          <tr id="buy-{{ I.id }}" class="buy-row" hidden>
            <td colspan="4">
              <form method="post" action="{{ BASE }}/shopping/item/mark_bought" class="grid buy-grid">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <div>
                  <label class="label">Magasin</label>
                  <input type="text" name="store" class="input" placeholder="Nom du magasin"
                    value="{{ I.store or '' }}">
                </div>
                <div>
                  <label class="label">Prix rayon (â‚¬/{{ I.unit or I.product_unit or '' }})</label>
                  <input type="number" name="shelf_unit_price" step="0.01" min="0" class="input"
                    value="{{ I.shelf_unit_price if I.shelf_unit_price is not none }}">
                </div>
                <div class="actions">
                  <button class="btn ok">Valider lâ€™achat</button>
                  <button type="button" class="btn secondary" data-closebuy="#buy-{{ I.id }}">Annuler</button>
                </div>
              </form>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile cards -->
    <div class="cards show-mobile">
      {% for I in ITEMS %}
      <article class="card {% if I.is_checked %}checked{% endif %}">
        <header class="card-h">
          <strong>{{ I.product_name }}</strong>
          {% if I.product_unit %}<span class="muted"> â€” {{ I.product_unit }}</span>{% endif %}
        </header>
        <div class="card-c">
          <div class="kv">
            <div><span class="k">QtÃ©</span><span class="v">{{ I.qty }} {{ I.unit or I.product_unit or '' }}</span></div>
            {% if I.note %}<div><span class="k">Note</span><span class="v mono">{{ I.note }}</span></div>{% endif %}
            {% if I.store %}<div><span class="k">Magasin</span><span class="v">{{ I.store }}</span></div>{% endif %}
            {% if I.shelf_unit_price is not none %}<div><span class="k">Prix rayon</span><span class="v">{{
                '%.2f'|format(I.shelf_unit_price) }} â‚¬</span></div>{% endif %}
            {% if I.ticket_unit_price is not none %}
            <div><span class="k">Ticket</span>
              <span class="v">{{ '%.2f'|format(I.ticket_unit_price) }} â‚¬ (Î” {{ '%.2f'|format(I.price_delta or
                (I.ticket_unit_price - (I.shelf_unit_price or 0))) }} â‚¬)</span>
            </div>
            {% endif %}
          </div>
        </div>
        <footer class="card-f right">
          {% if not I.is_checked %}
          <button class="btn xs ok" data-buy="#mbuy-{{ I.id }}">Acheter</button>
          <form method="post" action="{{ BASE }}/shopping/item/toggle" class="inline">
            <input type="hidden" name="item_id" value="{{ I.id }}">
            <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
            <button class="btn xs secondary">Cocher</button>
          </form>
          {% else %}
          <form method="post" action="{{ BASE }}/shopping/item/toggle" class="inline">
            <input type="hidden" name="item_id" value="{{ I.id }}">
            <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
            <button class="btn xs secondary">DÃ©cocher</button>
          </form>
          {% endif %}
          <form method="post" action="{{ BASE }}/shopping/item/delete" class="inline"
            onsubmit="return confirm('Supprimer cet item ?');">
            <input type="hidden" name="item_id" value="{{ I.id }}">
            <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
            <button class="btn xs danger">Suppr.</button>
          </form>
        </footer>

        {% if not I.is_checked %}
        <div id="mbuy-{{ I.id }}" class="mobile-buy" hidden>
          <form method="post" action="{{ BASE }}/shopping/item/mark_bought" class="grid buy-grid">
            <input type="hidden" name="item_id" value="{{ I.id }}">
            <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
            <div>
              <label class="label">Magasin</label>
              <input type="text" name="store" class="input" placeholder="Nom du magasin" value="{{ I.store or '' }}">
            </div>
            <div>
              <label class="label">Prix rayon (â‚¬/{{ I.unit or I.product_unit or '' }})</label>
              <input type="number" name="shelf_unit_price" step="0.01" min="0" class="input"
                value="{{ I.shelf_unit_price if I.shelf_unit_price is not none }}">
            </div>
            <div class="actions">
              <button class="btn ok">Valider</button>
              <button type="button" class="btn secondary" data-closebuy="#mbuy-{{ I.id }}">Annuler</button>
            </div>
          </form>
        </div>
        {% endif %}
      </article>
      {% endfor %}
    </div>
    {% endif %}
  </section>

  <!-- ContrÃ´le ticket (items achetÃ©s aujourd'hui) -->
  {% if PURCHASED_TODAY and PURCHASED_TODAY|length > 0 %}
  <section class="abox v2 ticket-check">
    <header class="abox-h">
      <strong>ContrÃ´le ticket (aujourdâ€™hui)</strong>
      <span class="muted">Anomalies: {{ ANOMALIES }} â€¢ Total Î”: {{ '%.2f'|format(TOTAL_DELTA) }} â‚¬</span>
    </header>
    <div class="abox-c">
      <div class="table-wrap">
        <table class="table">
          <colgroup>
            <col style="width:40%">
            <col style="width:14%">
            <col style="width:18%">
            <col style="width:28%">
          </colgroup>
          <thead>
            <tr>
              <th>Produit</th>
              <th>QtÃ©</th>
              <th>Rayon (â‚¬/u)</th>
              <th>Ticket (â‚¬/u) & Î”</th>
            </tr>
          </thead>
          <tbody>
            {% for I in PURCHASED_TODAY %}
            {% set delta = I.price_delta if I.price_delta is not none else I.computed_delta %}
            <tr
              class="{% if delta is not none and delta > 0.009 %}warn{% elif delta is not none and delta < -0.009 %}ok{% endif %}">
              <td>
                <div class="mono">{{ I.product_name }}</div>
                {% if I.store %}<small class="muted">Magasin: {{ I.store }}</small>{% endif %}
              </td>
              <td>{{ I.qty }} {{ I.unit or I.product_unit or '' }}</td>
              <td>{{ I.shelf_unit_price is not none and ('%.2f'|format(I.shelf_unit_price)) or 'â€”' }}</td>
              <td>
                <form method="post" action="{{ BASE }}/shopping/item/ticket_price" class="inline">
                  <input type="hidden" name="item_id" value="{{ I.id }}">
                  <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                  <input type="number" name="ticket_unit_price" step="0.01" min="0" class="input xs"
                    value="{{ I.ticket_unit_price if I.ticket_unit_price is not none }}">
                  <button class="btn xs">OK</button>
                </form>
                {% if delta is not none %}
                <small class="muted">Î” {{ '%.2f'|format(delta) }} â‚¬</small>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Dialog nouvelle liste -->
  <dialog id="dlg-new-list" class="modal">
    <form method="post" action="{{ BASE }}/shopping/list/create" class="modal-body">
      <header><strong>Nouvelle liste</strong></header>
      <div class="modal-content grid">
        <div>
          <label class="label">Nom</label>
          <input type="text" name="name" class="input" placeholder="Courses Semaine" required>
        </div>
        <div>
          <label class="label">Emoji (optionnel)</label>
          <input type="text" name="emoji" class="input" placeholder="ðŸ›’">
        </div>
      </div>
      <footer class="modal-actions right">
        <button type="button" class="btn secondary" data-close="#dlg-new-list">Annuler</button>
        <button class="btn">CrÃ©er</button>
      </footer>
    </form>
  </dialog>

</div>
{% endblock %}

{% block scripts %}
<script>
  // Ouvrir/fermer modales
  document.querySelectorAll("[data-open]").forEach(btn => {
    btn.addEventListener("click", () => {
      const dlg = document.querySelector(btn.getAttribute("data-open"));
      dlg && dlg.showModal();
    });
  });
  document.querySelectorAll("[data-close]").forEach(btn => {
    btn.addEventListener("click", () => {
      const dlg = document.querySelector(btn.getAttribute("data-close"));
      dlg && dlg.close();
    });
  });

  // Panneaux "Acheter" inline
  document.querySelectorAll("[data-buy]").forEach(btn => {
    btn.addEventListener("click", () => {
      const row = document.querySelector(btn.getAttribute("data-buy"));
      if (row) row.hidden = !row.hidden;
    });
  });
  document.querySelectorAll("[data-closebuy]").forEach(btn => {
    btn.addEventListener("click", () => {
      const row = document.querySelector(btn.getAttribute("data-closebuy"));
      if (row) row.hidden = true;
    });
  });

  // Toasts basÃ©s sur ?toast=
  (function () {
    const u = new URL(window.location);
    const t = u.searchParams.get("toast");
    if (!t) return;
    const map = {
      added_list: ["Liste crÃ©Ã©e.", "ok"],
      renamed_list: ["Liste renommÃ©e.", "ok"],
      deleted_list: ["Liste supprimÃ©e.", "warn"],
      added_item: ["Produit ajoutÃ© Ã  la liste.", "ok"],
      toggled: ["Statut mis Ã  jour.", "ok"],
      deleted_item: ["Item supprimÃ©.", "warn"],
      marked_bought: ["Achat enregistrÃ©.", "ok"],
      ticket_ok: ["Prix ticket enregistrÃ©.", "ok"],
      error: ["Une erreur est survenue.", "error"]
    };
    const payload = map[t] || null;
    if (payload && window.showToast) {
      window.showToast(payload[0], payload[1]);
    }
    // Nettoie lâ€™URL
    u.searchParams.delete("toast");
    window.history.replaceState({}, "", u);
  })();

  (function () {
    const form = document.querySelector('form[action$="/shopping/item/add"]');
    if (!form) return;
    form.addEventListener('submit', (e) => {
      const disp = form.querySelector('input[name="product_id_display"]');
      const hid = form.querySelector('#product_id_hidden');
      if (!disp || !hid) return;
      const m = String(disp.value || '').match(/^(\d+)\b/); // prend les chiffres au dÃ©but
      if (m) {
        hid.value = m[1];
      } else {
        e.preventDefault();
        if (window.showToast) window.showToast("Choisis un produit dans la liste.", "warn");
        disp.focus();
      }
    });
  })();
</script>
{% endblock %}