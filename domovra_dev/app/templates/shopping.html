{% extends "base.html" %}
{% block title %}Domovra ‚Äî üõí Liste de courses{% endblock %}

{% block content %}
<div class="wrap" data-page="shopping">

  <!-- Toolbar d‚Äô√©tat (compacte) -->
  <div class="shopping-toolbar">
    <div class="left">
      <a class="chip {% if STATUS!='done' %}active{% endif %}"
        href="{{ BASE }}shopping?list={{ ACTIVE_LIST_ID }}&status=todo">√Ä acheter</a>
      <a class="chip {% if STATUS=='done' %}active{% endif %}"
        href="{{ BASE }}shopping?list={{ ACTIVE_LIST_ID }}&status=done">Achet√©s</a>
    </div>
    <div class="right">
      <span class="chip muted">üßæ Ticket: {{ PURCHASED_TODAY|length or 0 }}</span>
      <span class="chip {% if ANOMALIES>0 %}warn{% else %}ok{% endif %}">
        Œî {{ '%.2f'|format(TOTAL_DELTA) }} ‚Ç¨
      </span>
    </div>
  </div>

  <!-- Carte principale -->
  <section class="abox v2">
    <header class="abox-h">
      <strong>üßæ Liste de courses</strong>
      <span class="muted">‚Üí maquette visuelle (style) + actions r√©elles</span>
      <div class="right">
        <button class="btn sm secondary" type="button" title="Ouvrir (maquette)">Ouvrir</button>
        <button class="btn sm secondary" type="button" title="G√©n√©rer (maquette)">G√©n√©rer (ruptures + &lt; min)</button>
      </div>
    </header>

    <div class="abox-c">

      <!-- Ligne: s√©lecteur de liste + cr√©er -->
      <div class="grid" style="grid-template-columns: 1fr auto; gap:.5rem;">
        <form class="inline" method="get" action="{{ BASE }}shopping">
          <label class="label sr-only">Liste</label>
          <input type="hidden" name="status" value="{{ STATUS }}">
          <select name="list" class="input">
            {% for L in LISTS %}
            <option value="{{ L.id }}" {% if L.id==ACTIVE_LIST_ID %}selected{% endif %}>
              {{ L.emoji or 'üõí' }} {{ L.name }} ‚Äî {{ L.to_buy or 0 }}
            </option>
            {% endfor %}
          </select>
          <button class="btn sm">Ouvrir</button>
        </form>

        <form class="inline right" method="post" action="{{ BASE }}shopping/list/create">
          <input class="input" name="name" placeholder="Cr√©er une nouvelle liste‚Ä¶" required>
          <input type="hidden" name="emoji" value="üõí">
          <button class="btn">Cr√©er</button>
        </form>
      </div>

      <!-- Ligne: Ajout rapide produit -->
      <div class="abox v2" style="margin-top:.75rem;">
        <header class="abox-h">
          <strong>‚Äî Ajouter un produit‚Ä¶ ‚Äî</strong>
        </header>
        <div class="abox-c">
          <form method="post" action="{{ BASE }}shopping/item/add" class="grid add-grid"
            style="grid-template-columns: minmax(260px,1fr) 120px 160px 1fr auto; gap:.5rem; align-items:center;">
            <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">

            <!-- Produit (recherche -> ID extrait) -->
            <div>
              <label class="label sr-only">Produit</label>
              <input list="products" name="product_id_display" class="input" autocomplete="off"
                placeholder="‚Äî Ajouter un produit‚Ä¶ ‚Äî" required>
              <input type="hidden" id="product_id_hidden" name="product_id">
              <datalist id="products">
                {% for P in PRODUCTS %}
                <option
                  value="{{ P.id }} ‚Äî {{ P.name }}{% if P.unit %} ({{ P.unit }}){% endif %}{% if P.barcode %} [{{ P.barcode }}]{% endif %}">
                </option>
                {% endfor %}
              </datalist>
            </div>

            <!-- Quantit√© -->
            <div>
              <label class="label sr-only">Quantit√©</label>
              <input class="input" type="number" name="qty" step="0.01" min="0" value="1">
            </div>

            <!-- Unit√© -->
            <div>
              <label class="label sr-only">Unit√©</label>
              <input class="input" type="text" name="unit" placeholder="Par d√©faut: unit√© du produit">
            </div>

            <!-- Note -->
            <div>
              <label class="label sr-only">Note</label>
              <input class="input" type="text" name="note" placeholder="Pr√©cision (marque, format‚Ä¶)">
            </div>

            <div class="right">
              <button class="btn">Ajouter</button>
            </div>
          </form>

          <div class="muted" style="margin-top:.25rem;">
            Si le produit n‚Äôexiste pas :
            <a class="link" href="{{ BASE }}products?toast=add_new">cr√©er un produit</a>.
          </div>
        </div>
      </div>

      <!-- Actions secondaires -->
      <div class="toolbar" style="margin-top:.75rem;display:flex;gap:.5rem;align-items:center;">
        <button class="btn sm secondary" type="button" title="Export CSV (√† venir)">üóÇÔ∏è Export CSV</button>
        <button class="btn sm secondary" type="button" onclick="window.print()">üñ®Ô∏è Imprimer</button>
        <button class="btn sm warn" type="button" title="Supprimer les coch√©s (√† venir)">üßπ Nettoyer (coch√©s)</button>
      </div>

      <!-- Liste des items -->
      <div class="list-block" style="margin-top:.75rem;">
        {% if ITEMS|length == 0 %}
        <p class="muted">Aucun article pour cette vue.</p>
        {% else %}
        <!-- Table desktop -->
        <div class="table-wrap hide-mobile">
          <table class="table">
            <colgroup>
              <col style="width:42%">
              <col style="width:10%">
              <col style="width:20%">
              <col style="width:28%">
            </colgroup>
            <thead>
              <tr>
                <th>Produit</th>
                <th>Qt√©</th>
                <th>Note</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for I in ITEMS %}
              <tr class="{% if I.is_checked %}checked{% endif %}">
                <td>
                  <div><strong class="mono">{{ I.product_name }}</strong></div>
                  {% if I.product_unit %}<small class="muted">Unit√©: {{ I.product_unit }}</small>{% endif %}
                  {% if I.store %}<div><small class="muted">Magasin: {{ I.store }}</small></div>{% endif %}
                  {% if I.shelf_unit_price is not none %}
                  <div><small class="muted">Prix rayon: {{ '%.2f'|format(I.shelf_unit_price) }} ‚Ç¨ / {{ I.unit or
                      I.product_unit or '' }}</small></div>
                  {% endif %}
                  {% if I.ticket_unit_price is not none %}
                  <div><small class="muted">Ticket: {{ '%.2f'|format(I.ticket_unit_price) }} ‚Ç¨ (Œî {{
                      '%.2f'|format(I.price_delta or (I.ticket_unit_price - (I.shelf_unit_price or 0))) }} ‚Ç¨)</small>
                  </div>
                  {% endif %}
                </td>
                <td>{{ I.qty }} <span class="muted">{{ I.unit or I.product_unit or '' }}</span></td>
                <td class="mono">{{ I.note or '' }}</td>
                <td class="right">
                  {% if not I.is_checked %}
                  <button class="btn sm ok" data-buy="#buy-{{ I.id }}">Acheter</button>
                  <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
                    <input type="hidden" name="item_id" value="{{ I.id }}">
                    <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                    <button class="btn sm secondary">Cocher</button>
                  </form>
                  {% else %}
                  <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
                    <input type="hidden" name="item_id" value="{{ I.id }}">
                    <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                    <button class="btn sm secondary">D√©cocher</button>
                  </form>
                  {% endif %}
                  <form method="post" action="{{ BASE }}shopping/item/delete" class="inline"
                    onsubmit="return confirm('Supprimer cet item ?');">
                    <input type="hidden" name="item_id" value="{{ I.id }}">
                    <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                    <button class="btn sm danger">Suppr.</button>
                  </form>
                </td>
              </tr>

              {% if not I.is_checked %}
              <!-- panneau Acheter inline -->
              <tr id="buy-{{ I.id }}" class="buy-row" hidden>
                <td colspan="4">
                  <form method="post" action="{{ BASE }}shopping/item/mark_bought" class="grid buy-grid"
                    style="grid-template-columns: 1.2fr 1fr auto; gap:.5rem; align-items:end;">
                    <input type="hidden" name="item_id" value="{{ I.id }}">
                    <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                    <div>
                      <label class="label">Magasin</label>
                      <input class="input" name="store" value="{{ I.store or '' }}" placeholder="Nom du magasin">
                    </div>
                    <div>
                      <label class="label">Prix rayon (‚Ç¨/{{ I.unit or I.product_unit or '' }})</label>
                      <input class="input" name="shelf_unit_price" type="number" step="0.01" min="0"
                        value="{{ I.shelf_unit_price if I.shelf_unit_price is not none }}">
                    </div>
                    <div class="right">
                      <button class="btn ok">Valider l‚Äôachat</button>
                      <button type="button" class="btn secondary" data-closebuy="#buy-{{ I.id }}">Annuler</button>
                    </div>
                  </form>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Cartes mobile -->
        <div class="cards show-mobile">
          {% for I in ITEMS %}
          <article class="card {% if I.is_checked %}checked{% endif %}">
            <header class="card-h"><strong>{{ I.product_name }}</strong> {% if I.product_unit %}<span class="muted">‚Äî {{
                I.product_unit }}</span>{% endif %}</header>
            <div class="card-c">
              <div class="kv">
                <div><span class="k">Qt√©</span><span class="v">{{ I.qty }} {{ I.unit or I.product_unit or '' }}</span>
                </div>
                {% if I.note %}<div><span class="k">Note</span><span class="v mono">{{ I.note }}</span></div>{% endif %}
                {% if I.store %}<div><span class="k">Magasin</span><span class="v">{{ I.store }}</span></div>{% endif %}
                {% if I.shelf_unit_price is not none %}<div><span class="k">Prix rayon</span><span class="v">{{
                    '%.2f'|format(I.shelf_unit_price) }} ‚Ç¨</span></div>{% endif %}
                {% if I.ticket_unit_price is not none %}
                <div><span class="k">Ticket</span><span class="v">{{ '%.2f'|format(I.ticket_unit_price) }} ‚Ç¨ (Œî {{
                    '%.2f'|format(I.price_delta or (I.ticket_unit_price - (I.shelf_unit_price or 0))) }} ‚Ç¨)</span></div>
                {% endif %}
              </div>
            </div>
            <footer class="card-f right">
              {% if not I.is_checked %}
              <button class="btn xs ok" data-buy="#mbuy-{{ I.id }}">Acheter</button>
              <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn xs secondary">Cocher</button>
              </form>
              {% else %}
              <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn xs secondary">D√©cocher</button>
              </form>
              {% endif %}
              <form method="post" action="{{ BASE }}shopping/item/delete" class="inline"
                onsubmit="return confirm('Supprimer cet item ?');">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <button class="btn xs danger">Suppr.</button>
              </form>
            </footer>

            {% if not I.is_checked %}
            <div id="mbuy-{{ I.id }}" class="mobile-buy" hidden>
              <form method="post" action="{{ BASE }}shopping/item/mark_bought" class="grid buy-grid"
                style="grid-template-columns: 1fr 1fr; gap:.5rem;">
                <input type="hidden" name="item_id" value="{{ I.id }}">
                <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                <div><label class="label">Magasin</label><input class="input" name="store" value="{{ I.store or '' }}">
                </div>
                <div><label class="label">Prix rayon (‚Ç¨/{{ I.unit or I.product_unit or '' }})</label>
                  <input class="input" name="shelf_unit_price" type="number" step="0.01" min="0"
                    value="{{ I.shelf_unit_price if I.shelf_unit_price is not none }}">
                </div>
                <div class="right" style="grid-column:1 / -1">
                  <button class="btn ok">Valider</button>
                  <button type="button" class="btn secondary" data-closebuy="#mbuy-{{ I.id }}">Annuler</button>
                </div>
              </form>
            </div>
            {% endif %}
          </article>
          {% endfor %}
        </div>
        {% endif %}
      </div>

    </div>
  </section>

  <!-- Contr√¥le ticket -->
  {% if PURCHASED_TODAY and PURCHASED_TODAY|length>0 %}
  <section class="abox v2" style="margin-top:.75rem;">
    <header class="abox-h">
      <strong>üßæ Contr√¥le ticket (aujourd‚Äôhui)</strong>
      <span class="muted">Anomalies: {{ ANOMALIES }} ‚Ä¢ Œî total: {{ '%.2f'|format(TOTAL_DELTA) }} ‚Ç¨</span>
    </header>
    <div class="abox-c">
      <div class="table-wrap">
        <table class="table">
          <colgroup>
            <col style="width:42%">
            <col style="width:12%">
            <col style="width:18%">
            <col style="width:28%">
          </colgroup>
          <thead>
            <tr>
              <th>Produit</th>
              <th>Qt√©</th>
              <th>Rayon (‚Ç¨/u)</th>
              <th>Ticket (‚Ç¨/u) & Œî</th>
            </tr>
          </thead>
          <tbody>
            {% for I in PURCHASED_TODAY %}
            {% set delta = I.price_delta if I.price_delta is not none else I.computed_delta %}
            <tr
              class="{% if delta is not none and delta > 0.009 %}warn{% elif delta is not none and delta < -0.009 %}ok{% endif %}">
              <td>
                <div class="mono">{{ I.product_name }}</div>{% if I.store %}<small class="muted">Magasin: {{ I.store
                  }}</small>{% endif %}
              </td>
              <td>{{ I.qty }} {{ I.unit or I.product_unit or '' }}</td>
              <td>{{ I.shelf_unit_price is not none and ('%.2f'|format(I.shelf_unit_price)) or '‚Äî' }}</td>
              <td>
                <form method="post" action="{{ BASE }}shopping/item/ticket_price" class="inline">
                  <input type="hidden" name="item_id" value="{{ I.id }}">
                  <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                  <input class="input xs" type="number" step="0.01" min="0" name="ticket_unit_price"
                    value="{{ I.ticket_unit_price if I.ticket_unit_price is not none }}">
                  <button class="btn xs">OK</button>
                </form>
                {% if delta is not none %}<small class="muted">Œî {{ '%.2f'|format(delta) }} ‚Ç¨</small>{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  // -- 1) Normalisation des actions pour √©viter // et garantir {{ BASE }}shopping/...
  (function () {
    const BASE = "{{ BASE }}";
    function joinBase(path) {
      path = String(path || "").replace(/^\//, "");
      let url = BASE + path;
      url = url.replace(/([^:]\/)\/+/g, "$1"); // compactage //
      return url;
    }
    document.querySelectorAll('form').forEach(form => {
      let act = form.getAttribute('action') || "";
      if (!/^https?:\/\//i.test(act)) {
        const m = act.match(/shopping\/[a-z_\/]+$/i);
        if (m) act = m[0];
        act = act.replace(/^\/+/, "");
        if (/^shopping(\/|$)/.test(act)) {
          form.setAttribute('action', joinBase(act));
        }
      }
    });
  })();

  // -- 2) Toggle panneaux "Acheter"
  document.querySelectorAll("[data-buy]").forEach(btn => {
    btn.addEventListener("click", () => {
      const row = document.querySelector(btn.getAttribute("data-buy"));
      if (row) row.hidden = !row.hidden;
    });
  });
  document.querySelectorAll("[data-closebuy]").forEach(btn => {
    btn.addEventListener("click", () => {
      const row = document.querySelector(btn.getAttribute("data-closebuy"));
      if (row) row.hidden = true;
    });
  });

  // -- 3) Ajout: transformer "123 ‚Äî Nom (unit√©)" -> product_id
  (function () {
    const form = document.querySelector('form[action*="shopping/item/add"]');
    if (!form) return;
    const disp = form.querySelector('input[name="product_id_display"]');
    const hid = form.querySelector('#product_id_hidden');
    const unit = form.querySelector('input[name="unit"]');

    function extract() {
      const s = String(disp.value || "");
      const mId = s.match(/^(\d+)\b/);
      if (mId) hid.value = mId[1];
      const mUnit = s.match(/\(([^)]+)\)/);
      if (mUnit && unit && !unit.value) unit.value = mUnit[1];
    }
    disp?.addEventListener('change', extract);
    disp?.addEventListener('blur', extract);
    form.addEventListener('submit', (e) => {
      extract();
      if (!hid.value) {
        e.preventDefault();
        window.showToast && window.showToast("Choisis un produit dans la liste.", "warn");
        disp.focus();
      }
    });
  })();

  // -- 4) Toast via ?toast=
  (function () {
    const u = new URL(window.location);
    const t = u.searchParams.get("toast");
    if (!t) return;
    const map = {
      added_list: ["Liste cr√©√©e.", "ok"],
      renamed_list: ["Liste renomm√©e.", "ok"],
      deleted_list: ["Liste supprim√©e.", "warn"],
      added_item: ["Produit ajout√©.", "ok"],
      marked_bought: ["Achat enregistr√©.", "ok"],
      ticket_ok: ["Prix ticket enregistr√©.", "ok"],
      toggled: ["Statut mis √† jour.", "ok"],
      deleted_item: ["Item supprim√©.", "warn"],
      error: ["Une erreur est survenue.", "error"]
    };
    const p = map[t]; if (p && window.showToast) window.showToast(p[0], p[1]);
    u.searchParams.delete("toast");
    history.replaceState({}, "", u);
  })();
</script>
{% endblock %}