{% extends "base.html" %}
{% block title %}Domovra ‚Äî üõí Liste de courses{% endblock %}

{% block content %}
<div class="wrap" data-page="shopping">

  <!-- Toolbar d‚Äô√©tat -->
  <div class="shopping-toolbar" role="region" aria-label="Filtres liste d‚Äôachats">
    <div class="left" role="tablist" aria-label="√âtat d‚Äôaffichage">
      <a class="chip {% if STATUS!='done' %}active{% endif %}"
        href="{{ BASE }}shopping?list={{ ACTIVE_LIST_ID }}&status=todo" role="tab"
        aria-selected="{{ STATUS!='done' }}">√Ä acheter</a>
      <a class="chip {% if STATUS=='done' %}active{% endif %}"
        href="{{ BASE }}shopping?list={{ ACTIVE_LIST_ID }}&status=done" role="tab"
        aria-selected="{{ STATUS=='done' }}">Achet√©s</a>
    </div>
    <div class="right">
      <span class="chip muted" aria-live="polite">üßæ Ticket: {{ PURCHASED_TODAY|length or 0 }}</span>
      <span class="chip {% if ANOMALIES>0 %}warn{% else %}ok{% endif %}" title="Delta total entre prix rayon et ticket">
        Œî {{ '%.2f'|format(TOTAL_DELTA) }} ‚Ç¨
      </span>
    </div>
  </div>

  <!-- Carte 1 : Liste -->
  <section class="abox v2" aria-labelledby="h-list">
    <header class="abox-h">
      <strong id="h-list">üßæ Liste de courses</strong>
      <span class="muted">‚Äî s√©lectionnez ou cr√©ez une liste</span>
      <div class="right">
        <button class="btn sm secondary" type="button" title="Ouvrir (maquette)">Ouvrir</button>
        <button class="btn sm secondary" type="button" title="G√©n√©rer (maquette)">G√©n√©rer (ruptures + &lt; min)</button>
      </div>
    </header>
    <div class="abox-c">
      <div class="grid-2">
        <!-- S√©lecteur de liste -->
        <form class="inline" method="get" action="{{ BASE }}shopping">
          <label class="label sr-only" for="shopping-list">Liste</label>
          <input type="hidden" name="status" value="{{ STATUS }}">
          <select id="shopping-list" name="list" class="input">
            {% for L in LISTS %}
            <option value="{{ L.id }}" {% if L.id==ACTIVE_LIST_ID %}selected{% endif %}>
              {{ L.emoji or 'üõí' }} {{ L.name }} ‚Äî {{ L.to_buy or 0 }}
            </option>
            {% endfor %}
          </select>
          <button class="btn sm">Ouvrir</button>
        </form>

        <!-- Cr√©er une liste -->
        <form class="inline right" method="post" action="{{ BASE }}shopping/list/create">
          <label class="label sr-only" for="new-list-name">Cr√©er une nouvelle liste</label>
          <input id="new-list-name" class="input" name="name" placeholder="Cr√©er une nouvelle liste‚Ä¶" required>
          <input type="hidden" name="emoji" value="üõí">
          <button class="btn">Cr√©er</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Carte 2 : Ajouter un produit -->
  <section class="abox v2" aria-labelledby="h-add">
    <header class="abox-h">
      <strong id="h-add">‚ûï Ajouter un produit</strong>
    </header>
    <div class="abox-c">
      <form method="post" action="{{ BASE }}shopping/item/add" class="grid add-grid grid-add"
        aria-label="Ajout rapide d‚Äôun produit">
        <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">

        <!-- Produit -->
        <div>
          <label class="label sr-only" for="product-id-display">Produit</label>
          <input id="product-id-display" list="products" name="product_id_display" class="input" autocomplete="off"
            placeholder="‚Äî Ajouter un produit‚Ä¶ ‚Äî" required>
          <input type="hidden" id="product_id_hidden" name="product_id">
          <datalist id="products">
            {% for P in PRODUCTS %}
            <option
              value="{{ P.id }} ‚Äî {{ P.name }}{% if P.unit %} ({{ P.unit }}){% endif %}{% if P.barcode %} [{{ P.barcode }}]{% endif %}">
            </option>
            {% endfor %}
          </datalist>
        </div>

        <!-- Quantit√© -->
        <div>
          <label class="label sr-only" for="qty">Quantit√©</label>
          <input id="qty" class="input" type="number" name="qty" step="0.01" min="0" value="1">
        </div>

        <!-- Unit√© -->
        <div>
          <label class="label sr-only" for="unit">Unit√©</label>
          <input id="unit" class="input" type="text" name="unit" placeholder="Par d√©faut: unit√© du produit">
        </div>

        <!-- Note -->
        <div>
          <label class="label sr-only" for="note">Note</label>
          <input id="note" class="input" type="text" name="note" placeholder="Pr√©cision (marque, format‚Ä¶)">
        </div>

        <div class="right">
          <button class="btn ok">Ajouter</button>
        </div>
      </form>

      <div class="muted" style="margin-top:.25rem;">
        Si le produit n‚Äôexiste pas :
        <a class="link" href="{{ BASE }}products?toast=add_new">cr√©er un produit</a>.
      </div>
    </div>
  </section>

  <!-- Carte 3 : Articles (outils dans le header) -->
  <section class="abox v2" aria-labelledby="h-items">
    <header class="abox-h">
      <strong id="h-items">üóíÔ∏è Articles</strong>
      <span class="muted">‚Äî {{ ITEMS|length or 0 }} √©l√©ment{{ (ITEMS|length or 0) > 1 and 's' or '' }}</span>
      <div class="right">
        <button class="btn sm secondary" type="button" title="Export CSV (√† venir)">üóÇÔ∏è Export CSV</button>
        <button class="btn sm secondary" type="button" onclick="window.print()">üñ®Ô∏è Imprimer</button>
        <button class="btn sm warn" type="button" title="Supprimer les coch√©s (√† venir)">üßπ Nettoyer (coch√©s)</button>
      </div>
    </header>

    <div class="abox-c">
      {% if ITEMS|length == 0 %}
      <p class="muted">Aucun article pour cette vue.</p>
      {% else %}

      <!-- Table desktop -->
      <div class="table-wrap hide-mobile">
        <table class="table" aria-describedby="table-caption">
          <caption id="table-caption" class="sr-only">Tableau des articles de la liste</caption>
          <colgroup>
            <col style="width:42%">
            <col style="width:10%">
            <col style="width:20%">
            <col style="width:28%">
          </colgroup>
          <thead>
            <tr>
              <th scope="col">Produit</th>
              <th scope="col">Qt√©</th>
              <th scope="col">Note</th>
              <th scope="col" class="right">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for I in ITEMS %}
            <tr class="{% if I.is_checked %}checked{% endif %}">
              <td>
                <div><strong class="mono">{{ I.product_name }}</strong></div>
                {% if I.product_unit %}<small class="muted">Unit√©: {{ I.product_unit }}</small>{% endif %}
                {% if I.store %}<div><small class="muted">Magasin: {{ I.store }}</small></div>{% endif %}
                {% if I.shelf_unit_price is not none %}
                <div><small class="muted">Prix rayon: {{ '%.2f'|format(I.shelf_unit_price) }} ‚Ç¨ / {{ I.unit or
                    I.product_unit or '' }}</small></div>
                {% endif %}
                {% if I.ticket_unit_price is not none %}
                <div><small class="muted">Ticket: {{ '%.2f'|format(I.ticket_unit_price) }} ‚Ç¨ (Œî {{
                    '%.2f'|format(I.price_delta or (I.ticket_unit_price - (I.shelf_unit_price or 0))) }} ‚Ç¨)</small>
                </div>
                {% endif %}
              </td>
              <td>{{ I.qty }} <span class="muted">{{ I.unit or I.product_unit or '' }}</span></td>
              <td class="mono">{{ I.note or '' }}</td>
              <td class="right">
                {% if not I.is_checked %}
                <button class="btn sm ok" data-buy="#buy-{{ I.id }}">Acheter</button>
                <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
                  <input type="hidden" name="item_id" value="{{ I.id }}">
                  <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                  <button class="btn sm secondary">Cocher</button>
                </form>
                {% else %}
                <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
                  <input type="hidden" name="item_id" value="{{ I.id }}">
                  <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                  <button class="btn sm secondary">D√©cocher</button>
                </form>
                {% endif %}
                <form method="post" action="{{ BASE }}shopping/item/delete" class="inline"
                  onsubmit="return confirm('Supprimer cet item ?');">
                  <input type="hidden" name="item_id" value="{{ I.id }}">
                  <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                  <button class="btn sm danger">Suppr.</button>
                </form>
              </td>
            </tr>

            {% if not I.is_checked %}
            <!-- panneau Acheter inline -->
            <tr id="buy-{{ I.id }}" class="buy-row" hidden>
              <td colspan="4">
                <form method="post" action="{{ BASE }}shopping/item/mark_bought" class="grid buy-grid grid-buy-desktop"
                  aria-label="Valider l‚Äôachat">
                  <input type="hidden" name="item_id" value="{{ I.id }}">
                  <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                  <div>
                    <label class="label" for="store-{{ I.id }}">Magasin</label>
                    <input id="store-{{ I.id }}" class="input" name="store" value="{{ I.store or '' }}"
                      placeholder="Nom du magasin">
                  </div>
                  <div>
                    <label class="label" for="shelf-{{ I.id }}">Prix rayon (‚Ç¨/{{ I.unit or I.product_unit or ''
                      }})</label>
                    <input id="shelf-{{ I.id }}" class="input" name="shelf_unit_price" type="number" step="0.01" min="0"
                      value="{{ I.shelf_unit_price if I.shelf_unit_price is not none }}">
                  </div>
                  <div class="right">
                    <button class="btn ok">Valider l‚Äôachat</button>
                    <button type="button" class="btn secondary" data-closebuy="#buy-{{ I.id }}">Annuler</button>
                  </div>
                </form>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Cartes mobile -->
      <div class="cards show-mobile" role="list">
        {% for I in ITEMS %}
        <article class="card {% if I.is_checked %}checked{% endif %}" role="listitem">
          <header class="card-h">
            <strong>{{ I.product_name }}</strong>
            {% if I.product_unit %}<span class="muted">‚Äî {{ I.product_unit }}</span>{% endif %}
          </header>
          <div class="card-c">
            <div class="kv">
              <div><span class="k">Qt√©</span><span class="v">{{ I.qty }} {{ I.unit or I.product_unit or '' }}</span>
              </div>
              {% if I.note %}<div><span class="k">Note</span><span class="v mono">{{ I.note }}</span></div>{% endif %}
              {% if I.store %}<div><span class="k">Magasin</span><span class="v">{{ I.store }}</span></div>{% endif %}
              {% if I.shelf_unit_price is not none %}<div><span class="k">Prix rayon</span><span class="v">{{
                  '%.2f'|format(I.shelf_unit_price) }} ‚Ç¨</span></div>{% endif %}
              {% if I.ticket_unit_price is not none %}
              <div><span class="k">Ticket</span><span class="v">{{ '%.2f'|format(I.ticket_unit_price) }} ‚Ç¨ (Œî {{
                  '%.2f'|format(I.price_delta or (I.ticket_unit_price - (I.shelf_unit_price or 0))) }} ‚Ç¨)</span></div>
              {% endif %}
            </div>
          </div>
          <footer class="card-f right">
            {% if not I.is_checked %}
            <button class="btn xs ok" data-buy="#mbuy-{{ I.id }}">Acheter</button>
            <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
              <input type="hidden" name="item_id" value="{{ I.id }}">
              <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
              <button class="btn xs secondary">Cocher</button>
            </form>
            {% else %}
            <form method="post" action="{{ BASE }}shopping/item/toggle" class="inline">
              <input type="hidden" name="item_id" value="{{ I.id }}">
              <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
              <button class="btn xs secondary">D√©cocher</button>
            </form>
            {% endif %}
            <form method="post" action="{{ BASE }}shopping/item/delete" class="inline"
              onsubmit="return confirm('Supprimer cet item ?');">
              <input type="hidden" name="item_id" value="{{ I.id }}">
              <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
              <button class="btn xs danger">Suppr.</button>
            </form>
          </footer>

          {% if not I.is_checked %}
          <div id="mbuy-{{ I.id }}" class="mobile-buy" hidden>
            <form method="post" action="{{ BASE }}shopping/item/mark_bought" class="grid buy-grid grid-buy-mobile"
              aria-label="Valider l‚Äôachat (mobile)">
              <input type="hidden" name="item_id" value="{{ I.id }}">
              <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
              <div>
                <label class="label" for="mstore-{{ I.id }}">Magasin</label>
                <input id="mstore-{{ I.id }}" class="input" name="store" value="{{ I.store or '' }}">
              </div>
              <div>
                <label class="label" for="mshelf-{{ I.id }}">Prix rayon (‚Ç¨/{{ I.unit or I.product_unit or '' }})</label>
                <input id="mshelf-{{ I.id }}" class="input" name="shelf_unit_price" type="number" step="0.01" min="0"
                  value="{{ I.shelf_unit_price if I.shelf_unit_price is not none }}">
              </div>
              <div class="right" style="grid-column:1 / -1">
                <button class="btn ok">Valider</button>
                <button type="button" class="btn secondary" data-closebuy="#mbuy-{{ I.id }}">Annuler</button>
              </div>
            </form>
          </div>
          {% endif %}
        </article>
        {% endfor %}
      </div>

      {% endif %}
    </div>
  </section>

  <!-- Carte 4 : Contr√¥le ticket -->
  {% if PURCHASED_TODAY and PURCHASED_TODAY|length>0 %}
  <section class="abox v2" aria-labelledby="h-ticket">
    <header class="abox-h">
      <strong id="h-ticket">üßæ Contr√¥le ticket (aujourd‚Äôhui)</strong>
      <span class="muted">Anomalies: {{ ANOMALIES }} ‚Ä¢ Œî total: {{ '%.2f'|format(TOTAL_DELTA) }} ‚Ç¨</span>
    </header>
    <div class="abox-c">
      <div class="table-wrap">
        <table class="table" aria-label="Contr√¥le ticket du jour">
          <colgroup>
            <col style="width:42%">
            <col style="width:12%">
            <col style="width:18%">
            <col style="width:28%">
          </colgroup>
          <thead>
            <tr>
              <th scope="col">Produit</th>
              <th scope="col">Qt√©</th>
              <th scope="col">Rayon (‚Ç¨/u)</th>
              <th scope="col">Ticket (‚Ç¨/u) & Œî</th>
            </tr>
          </thead>
          <tbody>
            {% for I in PURCHASED_TODAY %}
            {% set delta = I.price_delta if I.price_delta is not none else I.computed_delta %}
            <tr
              class="{% if delta is not none and delta > 0.009 %}warn{% elif delta is not none and delta < -0.009 %}ok{% endif %}">
              <td>
                <div class="mono">{{ I.product_name }}</div>
                {% if I.store %}<small class="muted">Magasin: {{ I.store }}</small>{% endif %}
              </td>
              <td>{{ I.qty }} {{ I.unit or I.product_unit or '' }}</td>
              <td>{{ I.shelf_unit_price is not none and ('%.2f'|format(I.shelf_unit_price)) or '‚Äî' }}</td>
              <td>
                <form method="post" action="{{ BASE }}shopping/item/ticket_price" class="inline">
                  <input type="hidden" name="item_id" value="{{ I.id }}">
                  <input type="hidden" name="list_id" value="{{ ACTIVE_LIST_ID }}">
                  <label class="sr-only" for="ticket-{{ I.id }}">Prix ticket</label>
                  <input id="ticket-{{ I.id }}" class="input xs" type="number" step="0.01" min="0"
                    name="ticket_unit_price" value="{{ I.ticket_unit_price if I.ticket_unit_price is not none }}">
                  <button class="btn xs">OK</button>
                </form>
                {% if delta is not none %}<small class="muted">Œî {{ '%.2f'|format(delta) }} ‚Ç¨</small>{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  // Normalisation des actions
  (function () {
    const BASE = "{{ BASE }}";
    function joinBase(path) {
      path = String(path || "").replace(/^\//, "");
      let url = BASE + path;
      url = url.replace(/([^:]\/)\/+/g, "$1");
      return url;
    }
    document.querySelectorAll('form').forEach(form => {
      let act = form.getAttribute('action') || "";
      if (!/^https?:\/\//i.test(act)) {
        const m = act.match(/shopping\/[a-z_\/]+$/i);
        if (m) act = m[0];
        act = act.replace(/^\/+/, "");
        if (/^shopping(\/|$)/.test(act)) form.setAttribute('action', joinBase(act));
      }
    });
  })();

  // Toggle panneaux "Acheter"
  (function () {
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-buy], [data-closebuy]");
      if (!btn) return;
      const sel = btn.getAttribute("data-buy") || btn.getAttribute("data-closebuy");
      const row = document.querySelector(sel);
      if (!row) return;
      if (btn.hasAttribute("data-buy")) {
        row.hidden = !row.hidden;
        if (!row.hidden) row.querySelector("input,button,select,textarea")?.focus({ preventScroll: true });
      } else {
        row.hidden = true;
      }
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") document.querySelectorAll('.buy-row:not([hidden]), .mobile-buy:not([hidden])').forEach(el => el.hidden = true);
    });
  })();

  // Ajout: transformer "123 ‚Äî Nom (unit√©)" -> product_id
  (function () {
    const form = document.querySelector('form[action*="shopping/item/add"]');
    if (!form) return;
    const disp = form.querySelector('input[name="product_id_display"]');
    const hid = form.querySelector('#product_id_hidden');
    const unit = form.querySelector('input[name="unit"]');

    function extract() {
      const s = String(disp.value || "");
      const mId = s.match(/^(\d+)\b/);
      if (mId) hid.value = mId[1];
      const mUnit = s.match(/\(([^)]+)\)/);
      if (mUnit && unit && !unit.value) unit.value = mUnit[1];
    }
    disp?.addEventListener('change', extract);
    disp?.addEventListener('blur', extract);
    form.addEventListener('submit', (e) => {
      extract();
      if (!hid.value) {
        e.preventDefault();
        window.showToast && window.showToast("Choisis un produit dans la liste.", "warn");
        disp.focus();
      }
    });
  })();

  // Toast via ?toast=
  (function () {
    const u = new URL(window.location);
    const t = u.searchParams.get("toast");
    if (!t) return;
    const map = {
      added_list: ["Liste cr√©√©e.", "ok"],
      renamed_list: ["Liste renomm√©e.", "ok"],
      deleted_list: ["Liste supprim√©e.", "warn"],
      added_item: ["Produit ajout√©.", "ok"],
      marked_bought: ["Achat enregistr√©.", "ok"],
      ticket_ok: ["Prix ticket enregistr√©.", "ok"],
      toggled: ["Statut mis √† jour.", "ok"],
      deleted_item: ["Item supprim√©.", "warn"],
      error: ["Une erreur est survenue.", "error"]
    };
    const p = map[t]; if (p && window.showToast) window.showToast(p[0], p[1]);
    u.searchParams.delete("toast");
    history.replaceState({}, "", u);
  })();
</script>
{% endblock %}