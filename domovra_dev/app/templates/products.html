{% extends "base.html" %}
{% block title %}Domovra ‚Äî Fiche produit{% endblock %}

{% block head %}{% endblock %}

{% block header_right %}
<span class="chip">üóÇÔ∏è Fiches produit : <b>{{ items|length }}</b></span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="product">

  <!-- Ajouter un produit -->
  <div class="card">
    <div class="title">
      <h2>Cr√©e une fiche produit</h2>
      <span class="muted">‚Üí cr√©er une fiche produit compl√®te</span>
    </div>

    <!-- grille (conserve ta classe pour r√©utiliser ton CSS) -->
    <form id="create_form" method="post" action="{{ BASE }}product/add" class="add-product-form gate-on">

      <!-- Nom & Description -->
      <div class="field" style="grid-column:1 / -1">
        <div class="label">Nom du produit <span class="help" tabindex="0" data-tip="Nom court et explicite."></span>
        </div>
        <input name="name" id="create_name" type="text" required placeholder="ex. P√¢tes, Lait demi-√©cr√©m√©">
      </div>

      <div class="field" style="grid-column:1 / -1" data-gate="create">
        <div class="label">Description <span class="help" tabindex="0" data-tip="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></span>
        </div>
        <textarea name="description" id="create_desc" rows="2" placeholder="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></textarea>
      </div>

      <!-- Ligne 1 -->
      <div class="field" data-gate="create">
        <div class="label">Emplacement par d√©faut <span class="help" tabindex="0"
            data-tip="L√† o√π tu ranges habituellement ce produit."></span></div>
        <select name="default_location_id" id="create_default_location_id">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field" data-gate="create">
        <div class="label">Unit√© par d√©faut</div>
        <select name="unit" id="create_unit">
          <optgroup label="Comptage">
            <option value="pi√®ce" selected>pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div class="field" data-gate="create">
        <div class="label">Cat√©gorie de produits</div>
        <select name="category" id="create_category">
          <option value="">‚Äî Choisir ‚Äî</option>

          <optgroup label="Alimentation">
            <option>Fruits & l√©gumes</option>
            <option>Viande</option>
            <option>Poisson & fruits de mer</option>
            <option>Produits laitiers</option>
            <option>≈íufs</option>
            <option>Charcuterie</option>
            <option>Fromages</option>
            <option>Boulangerie & p√¢tisserie</option>
            <option>C√©r√©ales, p√¢tes & riz</option>
            <option>√âpicerie sal√©e</option>
            <option>√âpicerie sucr√©e</option>
            <option>Conserves & bocaux</option>
            <option>Condiments & sauces</option>
            <option>Huiles & vinaigres</option>
            <option>Boissons</option>
            <option>Surgel√©s</option>
            <option>Bio / Sans gluten</option>
          </optgroup>

          <optgroup label="Non alimentaire">
            <option>Hygi√®ne & beaut√©</option>
            <option>Entretien & m√©nager</option>
            <option>Animaux</option>
            <option>B√©b√©</option>
            <option>Autre</option>
          </optgroup>
        </select>
      </div>

      <!-- Ligne 2 -->
      <div class="field" data-gate="create">
        <div class="label">Quantit√© minimum en stock <span class="help" tabindex="0"
            data-tip="Seuil d‚Äôalerte propre √† ce produit."></span></div>
        <div class="infield-qty">
          <input name="min_qty" id="create_min_qty" type="number" min="0" step="any" placeholder="ex. 1"
            value="{{ SETTINGS.low_stock_default }}">
          <span id="create_min_unit" class="suffix">pi√®ce</span>
        </div>
        <div class="hint muted" id="create_min_hint">Conseil : 1, 2, 3 pi√®ces‚Ä¶</div>
      </div>

      <div class="field" data-gate="create">
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="create_low_enabled">
          <option value="1" selected>Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <!-- Ligne 3 -->
      <div class="field" data-gate="create">
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <div class="segmented">
          <label><input type="radio" name="expiry_kind" value="DLC" checked><span>DLC</span></label>
          <label><input type="radio" name="expiry_kind" value="DDM"><span>DDM</span></label>
        </div>
      </div>

      <div class="field no-freeze-cell" data-gate="create">
        <label class="checkbox-inline">
          <input type="checkbox" id="create_no_freeze" name="no_freeze" value="1">
          <span>Ne doit pas √™tre congel√©</span>
        </label>
      </div>

      <div class="field" id="create_freeze_group" data-gate="create">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input name="default_freeze_shelf_days" id="create_freeze_shelf" type="number" min="1" placeholder="ex. 180">
      </div>

      <div class="field" data-gate="create">
        <div class="label">P√©remption par d√©faut (jours)</div>
        <input name="shelf" id="create_shelf" type="number" min="1" placeholder="ex. 90">
      </div>

      <!-- Bouton -->
      <div class="field btn-wide" data-gate="create">
        <button class="secondary" type="submit">Ôºã Ajouter</button>
      </div>
    </form>
  </div>

  <!-- Outils -->
  <div class="card">
    <div class="title">
      <h2>Outils</h2>
      <span class="muted">
        Recherche
        <span class="help" tabindex="0" aria-label="Aide recherche" data-tip="
Exemples :
‚Ä¢ nom : lait, chorizo, p√¢tes
‚Ä¢ cat√©gorie : produits laitiers
‚Ä¢ unit√© : g, L, ml
‚Ä¢ p√©remption : dlc, ddm
‚Ä¢ cong√©lation : interdit
‚Ä¢ code-barres : 3029330003533
Astuce : tu peux combiner (ex. ¬´ ddm produits laitiers ¬ª)."></span>
      </span>
    </div>

    <div class="row tools-row" style="align-items:center">
      <input id="q" type="search" placeholder="Rechercher une fiche produit‚Ä¶" />
    </div>
  </div>

  <!-- === Liste (CARTES UNIQUEMENT) ===================================== -->

  <div class="card">
    <div class="title">
      <h2>Fiches produit</h2><span class="muted">Cartes</span>
    </div>

    <div id="cardsGrid" class="cards-grid">
      {% for it in items %}
      {% set threshold = it.min_qty if it.min_qty is not none else SETTINGS.low_stock_default %}
      {% set is_low = (it.qty_total < (it.min_qty if it.min_qty is not none else 0) and (it.min_qty is not none)) %}
        <article class="prod-card"
        data-name="{{ (it.name ~ ' ' ~ (it.category or '') ~ ' ' ~ (it.unit or '') ~ ' ' ~ (it.barcode or ''))|lower }}"
        data-barcode="{{ (it.barcode or '')|lower }}" data-category="{{ (it.category or '')|lower }}"
        data-unit="{{ (it.unit or '')|lower }}" data-expiry="{{ (it.expiry_kind or 'DLC')|lower }}" {# "dlc" ou "ddm" #}
        data-freeze="{{ 1 if (it.no_freeze or 0)!=0 else 0 }}" {# 1=interdit de congeler #}
        data-location="{{ (loc_map.get((it.default_location_id|string)) or '')|lower if it.default_location_id else '' }}"
        data-lots="{{ it.lots_count|int }}" data-qty="{{ '%.3f'|format(it.qty_total) }}"
        data-hasbarcode="{{ 1 if it.barcode else 0 }}"
        data-low="{{ 1 if (it.min_qty is not none and it.qty_total < it.min_qty) else 0 }}">
        <header class="pc-head">
          <div class="pc-title">
            <h3 class="pc-name">{{ it.name }}</h3>
            {% if it.category %}<span class="pill">{{ it.category }}</span>{% endif %}
            {% if is_low %}<span class="pill danger">üîª Faible stock</span>{% endif %}
          </div>
          <div class="pc-sub muted">
            {{ it.unit }} / {{ it.expiry_kind or 'DLC' }}
            {% if it.no_freeze %} / ‚ùÑÔ∏è interdit{% endif %}
          </div>
        </header>

        <div class="pc-body">
          <div class="stat"><span class="k">Stocks</span><span class="v">{{ it.lots_count }}</span></div>
          {% set Q = fmt_qty(it.qty_total, it.unit) %}
          <div class="stat">
            <span class="k">Qt√© totale</span>
            <span class="v">{{ Q.v }} {{ (Q.u or it.unit)|pluralize_fr(Q.v) }}</span>
          </div>
          {% if it.min_qty is not none %}
          {% set M = fmt_qty(it.min_qty, it.unit) %}
          <div class="stat">
            <span class="k">Seuil min</span>
            <span class="v">{{ M.v }} {{ (M.u or it.unit)|pluralize_fr(M.v) }}</span>
          </div>
          {% endif %}
          {% if it.default_location_id %}
          <div class="stat"><span class="k">üìç Emplacement</span><span class="v">
              {{ loc_map.get((it.default_location_id|string)) or '‚Äî' }}
            </span></div>
          {% endif %}
          <div class="stat"><span class="k">Conservation (par d√©faut)</span><span class="v">{{
              it.default_shelf_life_days }} j</span></div>
          {% if it.description %}<div class="stat full"><span class="k">Description</span><span class="v">{{
              it.description }}</span></div>{% endif %}

          {% if it.last_price_unit %}
          <div class="stat">
            <span class="k">Dernier prix</span>
            <span class="v">{{ '%.2f'|format(it.last_price_unit) }} {{ it.price_label or '‚Ç¨/pi√®ce' }}</span>
          </div>
          {% endif %}
        </div>


        <footer class="pc-actions">
          {% set inf = insights.get(it.id) if insights else None %}
          <button class="secondary js-view-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-category="{{ it.category or '' }}" data-unit="{{ it.unit or '' }}"
            data-expiry-kind="{{ it.expiry_kind or 'DLC' }}" data-no-freeze="{{ 1 if (it.no_freeze or 0)!=0 else 0 }}"
            data-shelf="{{ it.default_shelf_life_days or '' }}"
            data-default-location="{{ it.default_location_id or '' }}" data-barcode="{{ it.barcode or '' }}"
            data-min="{{ it.min_qty if it.min_qty is not none else '' }}" data-desc="{{ it.description or '' }}"
            data-lots="{{ it.lots_count|int }}" data-qty="{{ '%.2f'|format(it.qty_total) }}"
            data-last-price="{{ '%.2f'|format(it.last_price_unit) if it.last_price_unit else '' }}"
            data-price-currency="{{ it.currency or '‚Ç¨' }}" data-price-label="{{ it.price_label or '‚Ç¨/pi√®ce' }}"
            data-price-history='{{ (it.price_history_json or "[]")|safe }}'
            data-stock-value="{{ '%.2f'|format(it.stock_value) if it.stock_value else '' }}"
            data-last-in="{{ inf.last_in if inf and inf.last_in else '' }}"
            data-last-out="{{ inf.last_out if inf and inf.last_out else '' }}">
            üëÅÔ∏è Voir
          </button>


          <button class="secondary js-edit-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-desc="{{ it.description or '' }}" data-default-location="{{ it.default_location_id or '' }}"
            data-min="{{ it.min_qty if it.min_qty is not none else '' }}"
            data-low-enabled="{{ 1 if (it.low_stock_enabled is not none and it.low_stock_enabled!=0) else 0 }}"
            data-expiry-kind="{{ (it.expiry_kind or 'DLC') }}" data-shelf="{{ it.default_shelf_life_days or '' }}"
            data-freeze-shelf="{{ it.default_freeze_shelf_days or '' }}"
            data-no-freeze="{{ 1 if (it.no_freeze is not none and it.no_freeze!=0) else 0 }}"
            data-category="{{ it.category or '' }}" data-unit="{{ it.unit or 'pi√®ce' }}"
            data-parent="{{ it.parent_id or '' }}">
            ‚úèÔ∏è Modifier
          </button>

          <button class="secondary js-delete-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-lots="{{ it.lots_count|int }}">
            üóëÔ∏è Supprimer
          </button>
        </footer>
        </article>
        {% endfor %}
    </div>
  </div>

</div>

<!-- ===== Dialogs ======================================================= -->

<!-- Voir (fiche compl√®te, lecture seule) -->
<dialog id="dlg-view">
  <div style="display:grid;gap:14px;min-width:min(820px,96vw)">
    <div class="tabs compact">
      <button class="tab active" type="button">Aper√ßu du produit</button>
      <a class="tab" id="v-tab-in" href="#">Entr√©es du stock</a>
      <a class="tab" id="v-tab-journal" href="#">Journal du stock</a>
      <span style="margin-left:auto" class="muted">üõí üßæ</span>
    </div>

    <h2 id="v-name" style="text-align:center;margin:0">‚Äî</h2>

    <div class="kv">
      <div><b>Quantit√© en stock :</b> <span id="v-qty">‚Äî</span></div>
      <div><b>Valeur du stock :</b> <span id="v-stock-value" class="muted">‚Äî (inconnu)</span></div>
      <div><b>Emplacement par d√©faut :</b> <span id="v-loc">‚Äî</span></div>
      <div><b>Dernier achat :</b> <span id="v-last-in">Jamais</span></div>
      <div><b>Derni√®re utilisation :</b> <span id="v-last-out">Jamais</span></div>
      <div><b>Dernier prix :</b> <span id="v-last-price">‚Äî</span></div>
      <div><b>Dur√©e moyenne de conservation :</b> <span id="v-avg-shelf">‚Äî</span></div>
      <div><b>Taux de p√©remption :</b> <span id="v-expired-rate">‚Äî</span></div>
    </div>

    <div>
      <h3 style="margin:8px 0 6px">Historique des prix</h3>
      <div id="v-price-chart" role="img" aria-label="Graphique de l'√©volution du prix du produit"
        style="border:1px dashed var(--line);border-radius:10px;padding:12px;min-height:240px">
        <!-- Graphique rendu en JS (renderPriceChart) -->
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-view').close()">Fermer</button>
    </div>
  </div>
</dialog>


<!-- √âditer -->
<dialog id="dlg-edit" class="modal">
  <form method="post" action="{{ BASE }}product/update" class="edit-form">
    <h3 class="dlg-title">Modifier la fiche produit</h3>
    <input type="hidden" name="product_id" id="dlg-product-id">

    <div>
      <div class="label">Nom</div>
      <input type="text" name="name" id="dlg-name" required>
    </div>

    <div>
      <div class="label">Description</div>
      <textarea name="description" id="dlg-desc" rows="2"></textarea>
    </div>

    <div class="row">
      <div>
        <div class="label">Emplacement par d√©faut</div>
        <select name="default_location_id" id="dlg-default-location">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <div class="label">Unit√©</div>
        <select name="unit" id="dlg-unit">
          <optgroup label="Comptage">
            <option value="pi√®ce">pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div>
        <div class="label">Quantit√© minimum en stock</div>
        <div class="infield-qty">
          <input name="min_qty" id="dlg-min" type="number" min="0" step="any" placeholder="ex. 1">
          <span class="suffix" id="dlg_min_unit">pi√®ce</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="dlg-low-enabled">
          <option value="1">Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <div>
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <select name="expiry_kind" id="dlg-exp-kind">
          <option value="DLC">DLC</option>
          <option value="DDM">DDM</option>
        </select>
      </div>

      <div>
        <div class="label">P√©remption par d√©faut (jours)</div>
        <input type="number" name="shelf" id="dlg-shelf" min="1" placeholder="ex. 90">
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">Ne doit pas √™tre congel√©</div>
        <input type="checkbox" id="dlg-no-freeze" name="no_freeze" value="1" class="chk">
      </div>

      <div id="dlg-freeze-group">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input type="number" name="default_freeze_shelf_days" id="dlg-freeze-shelf" min="1" placeholder="ex. 180">
      </div>

      <div>
        <div class="label">Cat√©gorie</div>
        <select name="category" id="dlg-category">
          <option value="">‚Äî Choisir ‚Äî</option>
          <optgroup label="Alimentation">
            <option>Fruits & l√©gumes</option>
            <option>Viande</option>
            <option>Poisson & fruits de mer</option>
            <option>Produits laitiers</option>
            <option>≈íufs</option>
            <option>Charcuterie</option>
            <option>Fromages</option>
            <option>Boulangerie & p√¢tisserie</option>
            <option>C√©r√©ales, p√¢tes & riz</option>
            <option>√âpicerie sal√©e</option>
            <option>√âpicerie sucr√©e</option>
            <option>Conserves & bocaux</option>
            <option>Condiments & sauces</option>
            <option>Huiles & vinaigres</option>
            <option>Boissons</option>
            <option>Surgel√©s</option>
            <option>Bio / Sans gluten</option>
          </optgroup>
          <optgroup label="Non alimentaire">
            <option>Hygi√®ne & beaut√©</option>
            <option>Entretien & m√©nager</option>
            <option>Animaux</option>
            <option>B√©b√©</option>
            <option>Autre</option>
          </optgroup>
        </select>
      </div>
    </div>

    <div class="dlg-actions">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlg-edit').close()">Annuler</button>
      <button class="secondary btn-save">Enregistrer</button>
    </div>
  </form>
</dialog>



<!-- Supprimer -->
<dialog id="dlg-delete">
  <form method="post" action="{{ BASE }}product/delete" style="display:grid;gap:10px;min-width:min(420px,92vw)">
    <h3 style="margin:0">Supprimer le produit</h3>
    <input type="hidden" name="product_id" id="del-product-id">
    <div class="muted" id="del-msg">La suppression retirera aussi les stocks li√©s √† ce produit.</div>
    <div class="dlg-actions">
      <button type="button" onclick="document.getElementById('dlg-delete').close()">Annuler</button>
      <button class="secondary btn-save">Supprimer</button>
    </div>
  </form>
</dialog>

{% endblock %}

{% block scripts %}
<script type="application/json" id="loc-map-data">
  {{ loc_map | tojson }}
</script>

<script>
  /* ====== Recherche intelligente (cartes) ======
     Exemples : ddm -has:barcode qty>0 | cat:"Produits laitiers" u:g is:low | loc:Frigo -nofreeze
     ‚ö†Ô∏é n√©cessite des data-attributes sur .prod-card : category, unit, expiry, freeze, location, lots, qty, hasbarcode, low
  */
  const q = document.getElementById('q');
  const grid = document.getElementById('cardsGrid');
  const cards = Array.from(grid ? grid.children : []);

  function tokenize(str) {
    const tokens = [];
    let cur = '', inQ = false;
    for (let i = 0; i < str.length; i++) {
      const c = str[i];
      if (c === '"') { inQ = !inQ; continue; }
      if (!inQ && /\s/.test(c)) { if (cur) { tokens.push(cur); cur = ''; } }
      else { cur += c; }
    }
    if (cur) tokens.push(cur);
    return tokens;
  }

  function parseQuery(qs) {
    const raw = (qs || '').trim().toLowerCase();
    if (!raw) return { text: [], filters: [], excludes: [] };

    const tokens = tokenize(raw);
    const text = [];
    const filters = [];
    const excludes = [];

    const pushFilter = (arr, key, op, val) => arr.push({ key, op, val });

    tokens.forEach(tok => {
      let t = tok, neg = false;
      if (t.startsWith('-')) { neg = true; t = t.slice(1); }

      if (t === 'dlc' || t === 'ddm') {
        pushFilter(neg ? excludes : filters, 'expiry', '==', t); return;
      }
      if (t === 'nofreeze' || t === 'freeze:no') {
        pushFilter(neg ? excludes : filters, 'freeze', '==', 1); return;
      }
      if (t === 'freeze:yes') {
        pushFilter(neg ? excludes : filters, 'freeze', '==', 0); return;
      }
      if (t === 'is:low' || t === 'low') {
        pushFilter(neg ? excludes : filters, 'low', '==', 1); return;
      }
      if (t === 'has:barcode') {
        pushFilter(neg ? excludes : filters, 'hasbarcode', '==', 1); return;
      }

      const m = t.match(/^([a-z]+)([=<>]{1,2})?(.*)$/);
      if (m) {
        let [, key, op, val] = m;
        key = key.trim(); op = (op || '==').trim(); val = (val || '').trim();
        if (val.startsWith(':')) val = val.slice(1);

        if (key === 'cat') key = 'category';
        if (key === 'u') key = 'unit';
        if (key === 'loc') key = 'location';
        if (key === 'ean') key = 'barcode';

        if (key === 'freeze') val = (/^(1|yes|true|on)$/i.test(val)) ? 1 : 0;
        if (['lots', 'qty'].includes(key)) {
          val = parseFloat(val.replace(',', '.'));
          if (Number.isNaN(val)) return;
        }
        pushFilter(neg ? excludes : filters, key, op, val);
        return;
      }

      text.push(t);
    });

    return { text, filters, excludes };
  }

  function matchesOps(num, op, val) {
    if (typeof num !== 'number' || Number.isNaN(num)) return false;
    switch (op) {
      case '>': return num > val;
      case '>=': return num >= val;
      case '<': return num < val;
      case '<=': return num <= val;
      case '!=': return num != val; // eslint-disable-line eqeqeq
      case '==':
      default: return num == val; // eslint-disable-line eqeqeq
    }
  }

  function cardMatches(card, query) {
    const txt = (card.dataset.name || '');

    for (const t of query.text) {
      if (!txt.includes(t)) return false;
    }

    const ds = card.dataset;

    for (const f of query.filters) {
      const k = f.key, op = f.op, v = f.val;
      switch (k) {
        case 'category':
        case 'unit':
        case 'location':
        case 'barcode':
        case 'expiry':
          if (!String(ds[k] || '').includes(String(v))) return false;
          break;

        case 'freeze':
        case 'low':
        case 'hasbarcode': {
          const cur = parseInt(ds[k] || '0', 10) || 0;
          if (!matchesOps(cur, op, parseInt(v, 10))) return false;
          break;
        }

        case 'lots': {
          const cur = parseInt(ds.lots || '0', 10) || 0;
          if (!matchesOps(cur, op, v)) return false;
          break;
        }
        case 'qty': {
          const cur = parseFloat(ds.qty || '0') || 0;
          if (!matchesOps(cur, op, v)) return false;
          break;
        }

        default:
          if (!txt.includes(String(v))) return false;
      }
    }

    for (const f of query.excludes) {
      const k = f.key, op = f.op, v = f.val;
      let hit = false;
      switch (k) {
        case 'category':
        case 'unit':
        case 'location':
        case 'barcode':
        case 'expiry':
          hit = String(ds[k] || '').includes(String(v)); break;
        case 'freeze':
        case 'low':
        case 'hasbarcode':
          hit = matchesOps(parseInt(ds[k] || '0', 10) || 0, op, parseInt(v, 10)); break;
        case 'lots':
          hit = matchesOps(parseInt(ds.lots || '0', 10) || 0, op, v); break;
        case 'qty':
          hit = matchesOps(parseFloat(ds.qty || '0') || 0, op, v); break;
        default:
          hit = txt.includes(String(v));
      }
      if (hit) return false;
    }

    return true;
  }

  let searchTimer = null;
  function runSmartSearch(qs) {
    const query = parseQuery(qs);
    let shown = 0;
    cards.forEach(card => {
      const ok = cardMatches(card, query);
      card.style.display = ok ? '' : 'none';
      if (ok) shown++;
    });
    const chip = document.querySelector('[data-page="product"] .chip b');
    if (chip) chip.textContent = String(qs ? shown : cards.length);
  }

  if (q) {
    q.placeholder = 'Ex.  ddm -has:barcode qty>0   |   cat:"Produits laitiers" u:g is:low';
    q.addEventListener('input', (e) => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => runSmartSearch(e.target.value), 120);
    });
  }

  /* ====== Helpers communs ====== */
  const $ = s => document.querySelector(s);

  // Config par unit√© (step visuel, suffixe, placeholder, hint)
  const UNIT_CFG = {
    'pi√®ce': { step: 1, suffix: 'pi√®ce', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 pi√®ces‚Ä¶' },
    'tranche': { step: 1, suffix: 'tranche', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 tranches‚Ä¶' },
    'paquet': { step: 1, suffix: 'paquet', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 paquets‚Ä¶' },
    'bo√Æte': { step: 1, suffix: 'bo√Æte', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bo√Ætes‚Ä¶' },
    'boite': { step: 1, suffix: 'bo√Æte', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bo√Ætes‚Ä¶' },
    'bocal': { step: 1, suffix: 'bocal', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bocaux‚Ä¶' },
    'bouteille': { step: 1, suffix: 'bouteille', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bouteilles‚Ä¶' },
    'sachet': { step: 1, suffix: 'sachet', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 sachets‚Ä¶' },
    'lot': { step: 1, suffix: 'lot', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 lots‚Ä¶' },
    'barquette': { step: 1, suffix: 'barquette', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 barquettes‚Ä¶' },
    'rouleau': { step: 1, suffix: 'rouleau', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 rouleaux‚Ä¶' },
    'dosette': { step: 1, suffix: 'dosette', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 dosettes‚Ä¶' },
    'g': { step: 50, suffix: 'g', placeholder: 'ex. 500', hint: 'Par 50 g (500 g, 750 g, ‚Ä¶)' },
    'kg': { step: 0.1, suffix: 'kg', placeholder: 'ex. 0.5', hint: 'Par 0,1 kg (0,5 kg, 1,0 kg, ‚Ä¶)' },
    'ml': { step: 50, suffix: 'ml', placeholder: 'ex. 500', hint: 'Par 50 ml (500 ml, 750 ml, ‚Ä¶)' },
    'L': { step: 1, suffix: 'L', placeholder: 'ex. 1', hint: 'Par 1 L (1 L, 2 L, ‚Ä¶)' },
    'l': { step: 1, suffix: 'L', placeholder: 'ex. 1', hint: 'Par 1 L (1 L, 2 L, ‚Ä¶)' },
  };
  function cfgForUnit(u) {
    const key = String(u || 'pi√®ce');
    return UNIT_CFG[key] || { step: 1, suffix: (u || 'pi√®ce'), placeholder: 'ex. 1', hint: '' };
  }

  function setSelectValue(sel, val) {
    if (!sel || sel.tagName !== 'SELECT') return;
    [...sel.querySelectorAll('option[data-temp="1"]')].forEach(o => o.remove());
    const opts = [...sel.options].map(o => o.value);
    if (opts.includes(val)) sel.value = val;
    else if (val) {
      const o = document.createElement('option');
      o.value = val; o.textContent = val + ' (autre)'; o.dataset.temp = '1';
      sel.insertBefore(o, sel.firstChild); sel.value = val;
    }
  }

  /* ====== Voir (fiche compl√®te, lecture seule) ====== */
  let locMap = {};
  try {
    const raw = document.getElementById('loc-map-data')?.textContent || '{}';
    locMap = JSON.parse(raw);
  } catch { locMap = {}; }

  function humanizeDate(iso) {
    if (!iso) return 'Jamais';
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    const today = new Date();
    const diff = Math.floor((today - d) / 86400000);
    if (diff <= 0) return "aujourd‚Äôhui";
    if (diff === 1) return "hier";
    return `${iso}  ¬∑  il y a ${diff} jour${diff > 1 ? 's' : ''}`;
  }

  function renderPriceChart(container, rows, currency) {
    container.innerHTML = '';

    // 1) garde-fous
    if (!Array.isArray(rows) || rows.length < 2) {
      container.textContent = 'Pas assez de donn√©es de prix pour tracer un graphique.';
      return;
    }

    // 2) parsing/tri
    const data = rows
      .map(r => ({
        date: new Date(r.date),            // ex. "2025-08-20"
        price: Number(r.price)
      }))
      .filter(d => !isNaN(d.date) && !isNaN(d.price))
      .sort((a, b) => a.date - b.date);

    if (data.length < 2) {
      container.textContent = 'Pas assez de donn√©es de prix pour tracer un graphique.';
      return;
    }

    // 3) dimensions & √©chelles
    const W = container.clientWidth || 560;
    const H = 240;
    const P = { l: 46, r: 10, t: 10, b: 28 };
    const x0 = P.l, x1 = W - P.r, y0 = H - P.b, y1 = P.t;

    const minP = Math.min(...data.map(d => d.price));
    const maxP = Math.max(...data.map(d => d.price));
    const pad = (maxP - minP) * 0.1 || 0.5; // marges visuelles
    const yMin = Math.max(0, minP - pad);
    const yMax = maxP + pad;

    const tMin = data[0].date.getTime();
    const tMax = data[data.length - 1].date.getTime();
    const tx = (t) => x0 + ((t - tMin) / (tMax - tMin || 1)) * (x1 - x0);
    const ty = (v) => y0 - ((v - yMin) / (yMax - yMin || 1)) * (y0 - y1);

    // 4) helpers SVG
    const NS = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(NS, 'svg');
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    svg.style.width = '100%';
    svg.style.height = H + 'px';

    // axes
    const axX = document.createElementNS(NS, 'line');
    axX.setAttribute('x1', x0); axX.setAttribute('x2', x1);
    axX.setAttribute('y1', y0); axX.setAttribute('y2', y0);
    axX.setAttribute('stroke', 'var(--line)');
    svg.appendChild(axX);

    const axY = document.createElementNS(NS, 'line');
    axY.setAttribute('x1', x0); axY.setAttribute('x2', x0);
    axY.setAttribute('y1', y0); axY.setAttribute('y2', y1);
    axY.setAttribute('stroke', 'var(--line)');
    svg.appendChild(axY);

    // grilles + labels Y (5 graduations)
    for (let i = 0; i <= 4; i++) {
      const v = yMin + (i / 4) * (yMax - yMin);
      const gy = ty(v);

      const gl = document.createElementNS(NS, 'line');
      gl.setAttribute('x1', x0); gl.setAttribute('x2', x1);
      gl.setAttribute('y1', gy); gl.setAttribute('y2', gy);
      gl.setAttribute('stroke', 'var(--line)');
      gl.setAttribute('stroke-dasharray', '4 4');
      svg.appendChild(gl);

      const lbl = document.createElementNS(NS, 'text');
      lbl.setAttribute('x', x0 - 8);
      lbl.setAttribute('y', gy + 4);
      lbl.setAttribute('text-anchor', 'end');
      lbl.setAttribute('fill', 'var(--muted)');
      lbl.setAttribute('font-size', '12');
      lbl.textContent = v.toFixed(2).replace('.', ',') + ' ' + (currency || '‚Ç¨');
      svg.appendChild(lbl);
    }

    // labels X : date min / date max
    const fmt = (d) => d.toISOString().slice(0, 10);
    [data[0].date, data[data.length - 1].date].forEach(d => {
      const txt = document.createElementNS(NS, 'text');
      txt.setAttribute('x', tx(d.getTime()));
      txt.setAttribute('y', y0 + 18);
      txt.setAttribute('text-anchor', 'middle');
      txt.setAttribute('fill', 'var(--muted)');
      txt.setAttribute('font-size', '12');
      txt.textContent = fmt(d);
      svg.appendChild(txt);
    });

    // courbe
    let dAttr = '';
    data.forEach((pt, i) => {
      const x = tx(pt.date.getTime()), y = ty(pt.price);
      dAttr += (i ? ' L ' : 'M ') + x + ' ' + y;
    });
    const path = document.createElementNS(NS, 'path');
    path.setAttribute('d', dAttr);
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', 'var(--accent, #4da3ff)');
    path.setAttribute('stroke-width', '2');
    svg.appendChild(path);

    // points
    data.forEach(pt => {
      const c = document.createElementNS(NS, 'circle');
      c.setAttribute('cx', tx(pt.date.getTime()));
      c.setAttribute('cy', ty(pt.price));
      c.setAttribute('r', '3');
      c.setAttribute('fill', 'var(--accent, #4da3ff)');
      c.setAttribute('aria-label', `${fmt(pt.date)} ¬∑ ${pt.price.toFixed(2).replace('.', ',')} ${(currency || '‚Ç¨')}`);
      svg.appendChild(c);
    });

    container.appendChild(svg);
  }


  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.js-view-open');
    if (!btn) return;

    const name = btn.dataset.name || 'Fiche produit';
    const unit = btn.dataset.unit || '';
    const qty = btn.dataset.qty || '0';
    const lots = btn.dataset.lots || '0';
    const loc = locMap[btn.dataset.defaultLocation || ''] || '‚Äî';

    const lastIn = humanizeDate(btn.dataset.lastIn || '');
    const lastOut = humanizeDate(btn.dataset.lastOut || '');

    const avgShelf = btn.dataset.avgShelf && btn.dataset.avgShelf !== '0' ? `${btn.dataset.avgShelf} j` : '‚Äî';
    const expRate = btn.dataset.expiredRate && btn.dataset.expiredRate !== '0' ? `${btn.dataset.expiredRate}%` : '0 %';

    document.getElementById('v-name').textContent = name;
    document.getElementById('v-qty').textContent =
      `${qty} ${unit}${Number(qty) == 1 ? '' : 's'} (${lots} lot${Number(lots) == 1 ? '' : 's'})`;
    document.getElementById('v-loc').textContent = loc;
    document.getElementById('v-last-in').textContent = lastIn;
    document.getElementById('v-last-out').textContent = lastOut;
    document.getElementById('v-avg-shelf').textContent = avgShelf;
    document.getElementById('v-expired-rate').textContent = expRate;

    // ==== PRIX / HISTORIQUE / VALEUR DE STOCK ====
    // Formatage prix
    function fmtPrice(n, cur) {
      if (n === null || n === undefined || n === '') return '‚Äî';
      const v = Number(n);
      if (!isFinite(v)) return '‚Äî';
      return v.toFixed(2).replace('.', ',') + ' ' + (cur || '‚Ç¨');
    }

    const currency = btn.dataset.priceCurrency || '‚Ç¨';

    // (A) Dernier prix = **prix unitaire** + libell√© (‚Ç¨/kg, ‚Ç¨/L, ‚Ç¨/pi√®ce)
    const lastPriceUnit = parseFloat(btn.dataset.lastPrice || '0') || 0;
    const priceLabel = btn.dataset.priceLabel || '‚Ç¨/pi√®ce';
    const vLast = document.getElementById('v-last-price');
    vLast.textContent = lastPriceUnit > 0
      ? (fmtPrice(lastPriceUnit, currency) + ' ' + priceLabel)
      : '‚Äî';

    // (B) Historique (pour le graphique et la date du dernier achat)
    let history = [];
    try { history = JSON.parse(btn.dataset.priceHistory || '[]'); } catch { }
    renderPriceChart(document.getElementById('v-price-chart'), history, currency);

    // Dernier achat = date la plus r√©cente de l'historique
    if (Array.isArray(history) && history.length) {
      const lastBuy = history
        .map(r => new Date(r.date))
        .filter(d => !isNaN(d))
        .sort((a, b) => b - a)[0];
      if (lastBuy) {
        document.getElementById('v-last-in').textContent =
          humanizeDate(lastBuy.toISOString().slice(0, 10));
      }
    }

    // (C) Valeur du stock ‚Äî priorit√© √† la **vraie valeur** calcul√©e c√¥t√© serveur
    const vStock = document.getElementById('v-stock-value');
    const stockValueData = parseFloat((btn.dataset.stockValue || '').replace(',', '.'));

    // Fallback minimal si jamais data-stock-value est absent : quantit√© √ó CMP
    function weightedAvgUnitPrice(rows) {
      let totalValue = 0, totalQty = 0;
      for (const r of (rows || [])) {
        const p = Number(r?.price);
        let q = Number(r?.qty);
        if (!isFinite(q) || q <= 0) q = 1;
        if (isFinite(p) && p > 0) { totalValue += p * q; totalQty += q; }
      }
      return totalQty > 0 ? (totalValue / totalQty) : 0;
    }

    const qtyNum = parseFloat((btn.dataset.qty || '0').replace(',', '.')) || 0;
    const cmp = weightedAvgUnitPrice(history) || lastPriceUnit; // on peut fallback sur le prix unitaire

    if (vStock) {
      if (isFinite(stockValueData) && stockValueData > 0) {
        // ‚úÖ vraie somme des lots restants (ex: 4,27 ‚Ç¨)
        vStock.textContent = fmtPrice(stockValueData, currency);
        vStock.classList.remove('muted');
      } else if (qtyNum > 0 && cmp > 0) {
        // ‚õëÔ∏è fallback de secours
        vStock.textContent = fmtPrice(qtyNum * cmp, currency);
        vStock.classList.remove('muted');
      } else {
        vStock.textContent = '‚Äî (inconnu)';
        vStock.classList.add('muted');
      }
    }

    const encoded = encodeURIComponent(name);
    const linkIn = document.getElementById('v-tab-in');
    const linkJ = document.getElementById('v-tab-journal');
    if (linkIn) linkIn.href = '{{ BASE }}lots?product=' + encoded;
    if (linkJ) linkJ.href = '{{ BASE }}journal';

    document.getElementById('dlg-view').showModal();
  }); // <-- FIN du handler .js-view-open


  /* ====== AJOUT : logique d‚Äôunit√© -> min_qty (step visuel + hint) ====== */
  (function setupCreateFormUnitLogic() {
    const unitSel = document.getElementById('create_unit');
    const minInput = document.getElementById('create_min_qty');
    const minSuffix = document.getElementById('create_min_unit');
    const minHint = document.getElementById('create_min_hint');
    const noFreeze = document.getElementById('create_no_freeze');
    const freezeGrp = document.getElementById('create_freeze_group');

    function applyCreateMinUnitLogic() {
      const u = unitSel?.value || 'pi√®ce';
      const cfg = cfgForUnit(u);
      if (minInput) {
        minInput.setAttribute('step', 'any');
        minInput.dataset.stepCustom = String(cfg.step);
        minInput.placeholder = cfg.placeholder;
      }
      if (minSuffix) minSuffix.textContent = cfg.suffix;
      if (minHint) minHint.textContent = cfg.hint || '';
    }
    function applyCreateFreezeVisibility() {
      if (!noFreeze || !freezeGrp) return;

      // Si le formulaire est "gate-on", on laisse le CSS masquer : aucune force inline
      const form = document.getElementById('create_form');
      if (form && form.classList.contains('gate-on')) {
        freezeGrp.style.removeProperty('display'); // nettoie les styles inline
        return;
      }

      // Sinon logique normale
      freezeGrp.style.display = noFreeze.checked ? 'none' : '';
    }

    if (unitSel) unitSel.addEventListener('change', applyCreateMinUnitLogic);
    if (noFreeze) noFreeze.addEventListener('change', applyCreateFreezeVisibility);

    applyCreateMinUnitLogic();
    applyCreateFreezeVisibility();
  })();


  /* ====== √âDITION : logique d‚Äôunit√© -> min_qty (step visuel) ====== */
  function applyDlgMinUnitLogic() {
    const unit = $('#dlg-unit')?.value || 'pi√®ce';
    const minInput = $('#dlg-min');
    const unitSuffix = $('#dlg_min_unit');
    if (!minInput || !unitSuffix) return;

    const cfg = cfgForUnit(unit);
    minInput.setAttribute('step', 'any');
    minInput.dataset.stepCustom = String(cfg.step);
    minInput.placeholder = cfg.placeholder;
    unitSuffix.textContent = cfg.suffix;
  }
  function applyDlgFreezeVisibility() {
    const nf = $('#dlg-no-freeze');
    const grp = $('#dlg-freeze-group');
    if (!nf || !grp) return;
    grp.style.display = nf.checked ? 'none' : '';
  }

  // Handler pour boutons "Modifier" et "Supprimer" (s√©par√© du handler .js-view-open)
  document.addEventListener('click', function (e) {
    const edit = e.target.closest('.js-edit-open');
    const del = e.target.closest('.js-delete-open');

    if (edit) {
      $('#dlg-product-id').value = edit.dataset.id || '';
      $('#dlg-name').value = edit.dataset.name || '';
      $('#dlg-desc').value = edit.dataset.desc || '';

      setSelectValue($('#dlg-default-location'), edit.dataset.defaultLocation || '');
      setSelectValue($('#dlg-unit'), edit.dataset.unit || 'pi√®ce');
      setSelectValue($('#dlg-low-enabled'), (edit.dataset.lowEnabled === '0' ? '0' : '1'));
      setSelectValue($('#dlg-exp-kind'), (edit.dataset.expiryKind || 'DLC').toUpperCase());

      const cat = $('#dlg-category');
      if (cat) setSelectValue(cat, edit.dataset.category || '');

      $('#dlg-min').value = (edit.dataset.min || '');
      $('#dlg-shelf').value = (edit.dataset.shelf || '');
      $('#dlg-freeze-shelf').value = (edit.dataset.freezeShelf || '');

      const nf = $('#dlg-no-freeze'); if (nf) nf.checked = (edit.dataset.noFreeze === '1');

      applyDlgFreezeVisibility();
      applyDlgMinUnitLogic();

      const unitSel = $('#dlg-unit');
      if (unitSel) unitSel.addEventListener('change', applyDlgMinUnitLogic);
      if (nf) nf.addEventListener('change', applyDlgFreezeVisibility);

      $('#dlg-edit').showModal();
      return;
    }

    if (del) {
      $('#del-product-id').value = del.dataset.id;
      const name = del.dataset.name || '';
      const lots = parseInt(del.dataset.lots || '0', 10);
      document.getElementById('del-msg').textContent = lots > 0
        ? `La suppression retirera aussi les ${lots} stock(s) li√©(s) √† ¬´ ${name} ¬ª.`
        : `Supprimer ¬´ ${name} ¬ª ?`;
      document.getElementById('dlg-delete').showModal();
      return;
    }
  });

  /* ====== Pas personnalis√©s via fl√®ches ‚Üë/‚Üì (sans bloquer la saisie libre) ====== */
  document.addEventListener('keydown', (e) => {
    const input = e.target.closest('input[type=number][data-step-custom]');
    if (!input) return;
    const step = parseFloat(input.dataset.stepCustom || '1');
    if (isNaN(step) || step <= 0) return;

    const cur = parseFloat(input.value || '0') || 0;
    if (e.key === 'ArrowUp') { e.preventDefault(); input.value = (cur + step).toString(); }
    if (e.key === 'ArrowDown') { e.preventDefault(); input.value = (cur - step).toString(); }
  });

  // ===== Verrouillage "Cr√©ation de fiche" tant que le nom est vide =====
  (function setupCreateNameGate() {
    const form = document.getElementById('create_form');
    const nameInput = document.getElementById('create_name');
    if (!form || !nameInput) return;

    const gatedBlocks = Array.from(form.querySelectorAll('[data-gate="create"]'));
    function getControls() {
      return gatedBlocks.flatMap(b => Array.from(b.querySelectorAll('input, select, textarea, button')));
    }

    function applyGate() {
      const hasName = (nameInput.value || '').trim().length > 0;

      // Pilote la classe gate-on
      form.classList.toggle('gate-on', !hasName);

      // (D√©)active les contr√¥les √† l‚Äôint√©rieur
      getControls().forEach(el => {
        if (!hasName) {
          el.setAttribute('disabled', 'disabled');
          el.setAttribute('aria-disabled', 'true');
        } else {
          el.removeAttribute('disabled');
          el.removeAttribute('aria-disabled');
        }
      });

      // Sync du bloc cong√©lation : on enl√®ve tout display inline,
      // et si le gate s'ouvre, on recalculera via l'√©v√©nement 'change'
      const freezeGrp = document.getElementById('create_freeze_group');
      const noFreeze = document.getElementById('create_no_freeze');
      if (freezeGrp) freezeGrp.style.removeProperty('display');
      if (hasName && noFreeze) {
        noFreeze.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }

    nameInput.addEventListener('input', applyGate);
    applyGate(); // √©tat initial au chargement
  })();
</script>
{% endblock %}