<h2>Journal</h2>

<div class="events-head" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <p class="muted" style="margin:0">Historique des actions (SQLite). Heures en local.</p>

    <div style="display:flex; gap:8px; align-items:center;">
        <!-- Filtre quantit√© de lignes -->
        <form method="get" action="{{ BASE }}settings" style="display:flex; gap:8px; align-items:center;">
            <input type="hidden" name="tab" value="journal">
            <label>
                Afficher
                <select name="jlimit">
                    {% for n in [50,100,200,500,1000] %}
                    <option value="{{ n }}" {{ 'selected' if n==jlimit }}>{{ n }}</option>
                    {% endfor %}
                </select>
                lignes
            </label>
            <button type="submit" class="secondary">Actualiser</button>
        </form>

        <!-- Vider le journal -->
        <form method="post" action="{{ BASE }}journal/clear"
            onsubmit="return confirm('Vider TOUT le journal ? Cette action est irr√©versible.');">
            <!-- Apr√®s vidage, revenir ici -->
            <input type="hidden" name="redirect_to" value="{{ BASE }}settings?tab=journal&cleared=1">
            <button type="submit" class="secondary">üóëÔ∏è Vider le journal</button>
        </form>
    </div>
</div>

<div id="flash" class="flash" style="display:none"></div>

{% if not events or events|length == 0 %}
<p class="muted">Aucun √©v√©nement pour le moment.</p>
{% else %}
<div class="table-responsive">
    <table class="events-table">
        <thead>
            <tr>
                <th class="nowrap">#</th>
                <th class="nowrap">Date</th>
                <th>Type</th>
                <th>D√©tails</th>
            </tr>
        </thead>
        <tbody>
            {% for ev in events %}
            {% set k = ev.kind|replace('.', '_') %}
            <tr>
                <td class="nowrap">{{ ev.id }}</td>
                <td class="nowrap">
                    <time class="ev-ts" datetime="{{ ev.created_at }}">{{ ev.created_at }}</time>
                </td>
                <td><span class="pill kind-{{ k }}">{{ ev.kind }}</span></td>
                <td class="code">
                    {% set d = ev.details if ev.details is not none else {} %}
                    {% if d is mapping %}
                    <pre class="code">{{ d | tojson(indent=2) }}</pre>
                    {% elif d is string %}
                    <pre class="code">{{ d }}</pre>
                    {% else %}
                    <span class="muted">‚Äî</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
    (function () {
        // Timestamps -> locale
        document.querySelectorAll('time.ev-ts').forEach(t => {
            try {
                const d = new Date(t.getAttribute('datetime'));
                if (!isNaN(d)) t.textContent = d.toLocaleString();
            } catch (e) { }
        });
        // Flash apr√®s vidage
        const p = new URLSearchParams(location.search);
        if (p.get('cleared') === '1') {
            const f = document.getElementById('flash');
            if (f) { f.style.display = 'block'; f.textContent = 'Journal vid√© ‚úÖ'; }
        }
    })();
</script>