{% extends "base.html" %}
{% block title %}Domovra — Accueil{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<div class="wrap"><!-- NOTE: conteneur principal de la page -->

  <!-- ===================== Consommer un produit ===================== -->
  <div class="card consume-card" data-role="consume">
    <div class="title">
      <h2>Consommer un produit</h2>
      <span class="muted">→ sélectionnez un produit</span>
    </div>

    <!-- Produit (combo custom + datalist caché en fallback) -->
    <div class="field">
      <div class="label">Produit</div>

      <div class="combo" data-combo="product">
        <input id="consume-product-input" placeholder="Commencez à taper..." autocomplete="off" role="combobox"
          aria-autocomplete="list" aria-expanded="false" aria-owns="consume-suggestions" />

        <!-- on garde le datalist pour le fallback et pour lire les options, mais on le cache -->
        <datalist id="consume-products-dl" hidden>
          {% for p in products %}
          {% set q = (totals.get(p.id, 0) if totals is defined else 0) | float %}
          {% set q_label = (('%.2f' % q) | trim('0') | trim('.')) %}
          <option value="{{ p.name }}" data-id="{{ p.id }}" data-brand="{{ p.brand or '' }}"
            data-unit="{{ p.unit or '' }}" data-stock="{{ '%.6f'|format(q) }}"
            data-stock-label="{% if q == 0 %}0{% else %}{{ q_label }}{% endif %} {{ p.unit|pluralize_fr(q) if p.unit is defined else '' }}">
            {{ p.name }}{% if p.brand %} — {{ p.brand }}{% endif %}{% if p.unit %} ({{ p.unit }}){% endif %}
          </option>
          {% endfor %}
        </datalist>

        <!-- notre dropdown custom -->
        <ul id="consume-suggestions" class="combo-list" role="listbox" hidden></ul>
      </div>

      <input type="hidden" id="consume-product-id">
    </div>

    <!-- ⬇️⬇️⬇️ TOUT CE BLOC EST MASQUÉ TANT QU’AUCUN PRODUIT VALIDE N’EST SÉLECTIONNÉ -->
    <div id="consume-details" hidden>

      <!-- Infos -->
      <div class="consume-infos grid-2">
        <div class="info">
          <div class="muted">FIFO (lot) / DLC</div>
          <div class="strong" id="consume-fifo">—</div>
        </div>
        <div class="info">
          <div class="muted">Emplacement</div>
          <div class="strong" id="consume-location">—</div>
        </div>
        <div class="info">
          <div class="muted">Quantité totale</div>
          <div class="strong">
            <span id="consume-total">—</span> <span id="consume-unit"></span>
          </div>
        </div>
        <div class="info">
          <div class="muted">Marque</div>
          <div class="strong" id="consume-brand">—</div>
        </div>
      </div>

      <!-- Quantité -->
      <div class="field">
        <div class="label">Quantité à consommer</div>
        <div class="qty-controls">
          <input id="consume-qty" type="number" inputmode="numeric" step="1" min="0" placeholder="0">
          <div class="quick-btns">
            <button type="button" class="btn small ghost" data-qset="1">1</button>
            <button type="button" class="btn small ghost" data-qset="2">2</button>
            <button type="button" class="btn small ghost" data-qset="3">3</button>
          </div>
        </div>
      </div>

      <!-- Bouton -->
      <div class="field">
        <button type="button" class="btn secondary" id="consume-validate" disabled>Valider la consommation</button>
        <div class="muted small">Consomme en FIFO (lot(s) à DLC la plus proche).</div>
      </div>

    </div>
    <!-- ⬆️⬆️⬆️ FIN DU BLOC MASQUÉ QUAND PAS DE PRODUIT -->

  </div><!-- /.card.consume-card -->

  <!-- ===================== Script ===================== -->
  <script>
    // NOTE : BASE fournie par le back via ingress_base()
    // Exemple sous HA : "/api/hassio_ingress/xxxxxxxx/"
    window.__DOMOVRA_BASE__ = "{{ BASE }}";
  </script>

  <script>
    (function () {
      // ----- BASE ingress (déjà défini plus haut par le backend) -----
      const BASE = (window.__DOMOVRA_BASE__ || '/').toString();

      // ----- Sélecteurs DOM -----
      const $input = document.getElementById('consume-product-input');
      const $hiddenId = document.getElementById('consume-product-id');
      const $dl = document.getElementById('consume-products-dl');
      const $list = document.getElementById('consume-suggestions');   // dropdown custom

      // bloc à masquer / afficher
      const $details = document.getElementById('consume-details');
      function setDetailsVisible(v) { if ($details) $details.hidden = !v; }
      setDetailsVisible(false);

      // champs infos
      const $fifo = document.getElementById('consume-fifo');
      const $loc = document.getElementById('consume-location');
      const $tot = document.getElementById('consume-total');
      const $unit = document.getElementById('consume-unit');
      const $brand = document.getElementById('consume-brand');

      // quantité
      const $qty = document.getElementById('consume-qty');
      const $btns = document.querySelectorAll('.quick-btns [data-qset]');
      const $validate = document.getElementById('consume-validate');

      // (optionnels) liens debug JSON
      const $debugRow = document.getElementById('consume-debug');
      const $jsonLink = document.getElementById('consume-json-link');
      const $jsonMeta = document.getElementById('consume-json-meta');

      let lastInfo = null;

      // ----- utils -----
      const log = (...a) => { try { console.log('[consume]', ...a) } catch { } };
      const dbg = (...a) => { try { console.debug('[consume]', ...a) } catch { } };
      const warn = (...a) => { try { console.warn('[consume]', ...a) } catch { } };
      const err = (...a) => { try { console.error('[consume]', ...a) } catch { } };

      function normalize(s) {
        return (s || '').toString().trim().toLowerCase()
          .normalize('NFD').replace(/\p{Diacritic}/gu, '')
          .replace(/\s+/g, ' ');
      }

      function makeIngressUrl(path, params) {
        const cleanBase = BASE.endsWith('/') ? BASE : (BASE + '/');
        const cleanPath = String(path || '').replace(/^\/+/, '');
        const u = new URL(cleanBase + cleanPath, window.location.origin);
        if (params) for (const [k, v] of Object.entries(params)) u.searchParams.set(k, v);
        return u.toString();
      }

      // ===================================================================
      //  Combobox custom (UI de la liste des produits)
      // ===================================================================
      let itemsIndex = []; // {id,name,brand,unit,norm}
      let results = [];
      let activeIndex = -1;

      // on lit les <option> du datalist pour faire notre index
      (function buildIndex() {
        itemsIndex = Array.from($dl.options).map(opt => {
          const name = (opt.value || '').trim();
          const id = opt.getAttribute('data-id') ? parseInt(opt.getAttribute('data-id'), 10) : null;
          const brand = opt.getAttribute('data-brand') || '';
          const unit = opt.getAttribute('data-unit') || '';

          const stock = parseFloat(opt.getAttribute('data-stock') || '0') || 0;
          const stockLabel = (opt.getAttribute('data-stock-label') || '').trim();

          return { id, name, brand, unit, stock, stockLabel, norm: normalize(name) };
        }).filter(x => x.id);

        // (facultatif) tri alpha
        itemsIndex.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));

      })();
      itemsIndex.sort((a, b) => a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' }));


      function openList() { $list.hidden = false; $input.setAttribute('aria-expanded', 'true'); }
      function closeList() { $list.hidden = true; $input.setAttribute('aria-expanded', 'false'); activeIndex = -1; }
      function setActive(i) {
        activeIndex = i;
        Array.from($list.children).forEach((li, idx) => li.classList.toggle('is-active', idx === i));
      }
      function highlight(text, query) {
        if (!query) return text;
        try {
          const q = normalize(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(`(${q})`, 'ig');
          return text.replace(re, '<mark>$1</mark>');
        } catch { return text; }
      }

      function renderList(q) {
        const qn = normalize(q);
        const MAX = 8;

        if (qn) {
          const starts = itemsIndex.filter(it => it.norm.startsWith(qn));
          const others = itemsIndex.filter(it => it.norm.includes(qn) && !it.norm.startsWith(qn));
          results = [...starts, ...others].slice(0, MAX);
        } else {
          results = itemsIndex.slice(0, MAX);
        }

        if (!results.length) {
          $list.innerHTML = '';
          closeList();
          return;
        }

        $list.innerHTML = results.map((it, i) => {
          // Texte « quantité + unité » (déjà préparé côté datalist → data-stock-label),
          // avec un fallback simple si jamais il est vide.
          const stockText = (it.stockLabel || '').trim() || `0 ${it.unit || ''}`;
          const brandPart = it.brand ? `${it.brand} · ` : '';

          return `
      <li class="combo-item" role="option" data-idx="${i}">
        <div>
          <div class="title">${highlight(it.name, q)}</div>
          <div class="meta">${brandPart}${stockText}</div>
        </div>
      </li>
    `;
        }).join('');

        Array.from($list.querySelectorAll('.combo-item')).forEach(li => {
          li.addEventListener('mousedown', ev => ev.preventDefault()); // éviter le blur
          li.addEventListener('click', () => {
            const idx = parseInt(li.getAttribute('data-idx'), 10) || 0;
            chooseResult(idx);
          });
        });

        setActive(0);
        openList();
      }

      function chooseResult(idx) {
        const it = results[idx];
        if (!it) return;
        $input.value = it.name;
        $hiddenId.value = String(it.id);
        closeList();
        $input.dispatchEvent(new Event('change', { bubbles: true })); // lance le fetch
      }

      // événements du champ
      $input.addEventListener('input', (e) => {
        const v = (e.target.value || '').trim();
        if (v.length === 0) { closeList(); setDetailsVisible(false); return; }
        renderList(v);
      });
      $input.addEventListener('keydown', (e) => {
        if ($list.hidden && e.key === 'ArrowDown') {
          e.preventDefault();
          renderList(($input.value || ''));
          return;
        }
        if ($list.hidden) return;

        const max = results.length - 1;
        if (e.key === 'ArrowDown') { e.preventDefault(); setActive(Math.min(max, activeIndex + 1)); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); setActive(Math.max(0, activeIndex - 1)); }
        else if (e.key === 'Enter') { e.preventDefault(); chooseResult(activeIndex >= 0 ? activeIndex : 0); }
        else if (e.key === 'Escape') { closeList(); }
      });
      $input.addEventListener('focus', () => {
        // affiche toujours la liste à l'ouverture du champ
        renderList(($input.value || ''));
      });
      $input.addEventListener('blur', () => setTimeout(closeList, 100));

      // ===================================================================
      //  Logique métier (fetch infos, presets, consommation, etc.)
      // ===================================================================
      const nameMap = new Map(itemsIndex.map(it => [it.norm, { id: it.id, brand: it.brand, unit: it.unit }]));

      function findSelectedProduct() {
        const val = ($input.value || '').trim();
        if (!val) return null;
        if (window.CSS && CSS.escape) {
          const opt = $dl.querySelector(`option[value="${CSS.escape(val)}"]`);
          if (opt) {
            const id = opt.getAttribute('data-id');
            return id ? { id: parseInt(id, 10) } : null;
          }
        }
        const rec = nameMap.get(normalize(val));
        return rec && rec.id ? { id: rec.id } : null;
      }

      async function fetchProductInfo(pid) {
        const url = makeIngressUrl('api/product-info', { product_id: String(pid) });
        dbg('GET', url);
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const txt = await r.text();
        dbg('Response', r.status, txt);
        let data = null; try { data = JSON.parse(txt); } catch { }
        if (!r.ok) return { error: 'http', status: r.status };
        return data ?? { error: 'parse' };
      }

      function updateDebugLink(pid) {
        if (!$debugRow || !$jsonLink) return;
        if (pid) {
          const url = makeIngressUrl('api/product-info', { product_id: String(pid) });
          $jsonLink.href = url;
          if ($jsonMeta) $jsonMeta.textContent = ` (product_id=${pid})`;
          $debugRow.style.display = '';
        } else {
          $jsonLink.removeAttribute('href');
          if ($jsonMeta) $jsonMeta.textContent = '';
          $debugRow.style.display = 'none';
        }
      }

      function currentQty() {
        const v = parseFloat(($qty.value || '').replace(',', '.'));
        return isFinite(v) && v > 0 ? v : 0;
      }

      function updateValidateState() {
        const pid = ($hiddenId.value || '').trim();
        const q = currentQty();
        const stock = lastInfo ? (typeof lastInfo.total_qty === 'number'
          ? lastInfo.total_qty : parseFloat(lastInfo.total_qty || '0') || 0) : 0;
        $validate.disabled = !(pid && q > 0 && stock > 0);
      }

      // unités → presets
      function classifyUnit(raw) {
        const u = String(raw || '').trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
        if (['l', 'litre', 'litres'].includes(u)) return { kind: 'volume', base: 'l' };
        if (['ml', 'millilitre', 'millilitres'].includes(u)) return { kind: 'volume', base: 'ml' };
        if (['cl', 'centilitre', 'centilitres'].includes(u)) return { kind: 'volume', base: 'cl' };
        if (['kg', 'kilogramme', 'kilogrammes'].includes(u)) return { kind: 'weight', base: 'kg' };
        if (['g', 'gramme', 'grammes'].includes(u)) return { kind: 'weight', base: 'g' };
        const count = ['piece', 'pieces', 'pièce', 'pièces', 'bouteille', 'bouteilles', 'paquet', 'paquets', 'tranche', 'tranches', 'boite', 'boites', 'boîte', 'boîtes', 'bocal', 'bocaux'];
        if (count.includes(u)) return { kind: 'count', base: 'u' };
        return { kind: 'count', base: 'u' };
      }
      function unitPreset(rawUnit) {
        const u = classifyUnit(rawUnit);
        const B = (value, label) => ({ value, label });
        if (u.kind === 'volume') {
          if (u.base === 'l') return { step: 0.1, buttons: [B(0.1, '0,1 L'), B(0.5, '0,5 L'), B(1, '1 L')], formatHint: 'L' };
          if (u.base === 'ml') return { step: 50, buttons: [B(100, '0,1 L'), B(500, '0,5 L'), B(1000, '1 L')], formatHint: 'ml→L' };
          if (u.base === 'cl') return { step: 1, buttons: [B(10, '0,1 L'), B(50, '0,5 L'), B(100, '1 L')], formatHint: 'cl→L' };
        }
        if (u.kind === 'weight') {
          if (u.base === 'kg') return { step: 0.1, buttons: [B(0.1, '0,1 kg'), B(0.5, '0,5 kg'), B(1, '1 kg')], formatHint: 'kg' };
          if (u.base === 'g') return { step: 50, buttons: [B(100, '0,1 kg'), B(500, '0,5 kg'), B(1000, '1 kg')], formatHint: 'g→kg' };
        }
        return { step: 1, buttons: [B(1, '1'), B(2, '2'), B(3, '3')], formatHint: 'u' };
      }
      function applyUnitPreset(rawUnit) {
        const preset = unitPreset(rawUnit);
        $qty.setAttribute('step', String(preset.step || 1));
        Array.from(document.querySelectorAll('.quick-btns [data-qset]')).forEach((b, i) => {
          const conf = preset.buttons[i] || { value: i + 1, label: String(i + 1) };
          b.setAttribute('data-qset', String(conf.value));
          b.textContent = conf.label;
        });
        if (preset.formatHint === 'ml→L' || preset.formatHint === 'cl→L') $qty.placeholder = '0 (en ml/cl)';
        else if (preset.formatHint === 'g→kg') $qty.placeholder = '0 (en g)';
        else $qty.placeholder = '0';
      }

      function fillInfos(payload) {
        if (!payload || payload.error) {
          lastInfo = null;
          setDetailsVisible(false);
          const msg = payload?.error === 'http' ? `Erreur HTTP ${payload.status}` :
            payload?.error === 'parse' ? 'Réponse illisible' : 'Erreur réseau';
          warn('fillInfos error:', payload);
          $fifo.textContent = msg || '—';
          $loc.textContent = '—';
          $tot.textContent = '—';
          $unit.textContent = '';
          $brand.textContent = '—';
          updateValidateState();
          applyUnitPreset(null);
          return;
        }

        lastInfo = payload;
        setDetailsVisible(true);

        const fifo = payload.fifo || {};
        const lotId = fifo.lot_id ?? null;
        const lotName = fifo.article_name ?? null;
        const dlc = fifo.best_before ?? null;

        const parts = [];
        if (lotName) parts.push(String(lotName).trim());
        if (lotId != null) parts.push('#' + lotId);
        if (dlc) parts.push(dlc);
        $fifo.textContent = parts.length ? parts.join(' — ') : 'Aucun lot dispo';

        $loc.textContent = fifo.location || '—';

        const t = (typeof payload.total_qty === 'number') ? payload.total_qty
          : (parseFloat(payload.total_qty || '0') || 0);
        $tot.textContent = t.toString();

        const unitText = (payload.unit && String(payload.unit).trim()) || '';
        $unit.textContent = unitText;
        applyUnitPreset(unitText);

        let brandFromApi = (payload.brand && String(payload.brand).trim()) || '';
        if (!brandFromApi) {
          const val = ($input.value || '').trim();
          const opt = Array.from($dl.options).find(o => (o.value || '').trim() === val);
          brandFromApi = (opt && opt.getAttribute('data-brand') || '').trim();
        }
        $brand.textContent = brandFromApi || '—';

        updateValidateState();
      }

      async function onProductChanged() {
        // ne fetch que si un produit est parfaitement identifié
        $hiddenId.value = '';
        setDetailsVisible(false);
        const sel = findSelectedProduct();
        updateDebugLink(sel && sel.id ? sel.id : null);
        if (!sel || !sel.id) return;

        dbg('onProductChanged -> product_id', sel.id);
        $hiddenId.value = String(sel.id);
        const data = await fetchProductInfo(sel.id);
        fillInfos(data);
      }

      function onQuickBtn(e) {
        const val = parseInt(e.currentTarget.getAttribute('data-qset'), 10) || 0;
        $qty.value = val ? String(val) : '';
        $qty.dispatchEvent(new Event('input'));
      }

      async function postLotConsume(lotId, qty) {
        const url = new URL(makeIngressUrl('lot/consume'), window.location.origin);
        const form = new URLSearchParams();
        form.set('lot_id', String(lotId));
        form.set('qty', String(qty));
        const r = await fetch(url.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString()
        });
        return r.ok;
      }

      async function logEvent(kind, payload) {
        const url = makeIngressUrl('api/log');
        try {
          await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ kind, payload }) });
        } catch (e) { warn('logEvent failed', e); }
      }

      async function consumeFIFO(pid, qty) {
        const info = (lastInfo && lastInfo.product_id === pid) ? lastInfo : await fetchProductInfo(pid);
        if (!info || info.error) throw new Error('info unavailable');
        if (!info.lots || info.lots.length === 0) throw new Error('no stock');

        const productName = ($input.value || '').trim();
        const unit = (info.unit || '').trim();

        let remaining = qty;
        let consumed = 0;
        const ops = [];

        for (const l of info.lots) {
          if (remaining <= 1e-12) break;
          const lotQty = parseFloat(l.qty || '0') || 0;
          if (lotQty <= 0) continue;

          const take = Math.min(remaining, lotQty);
          const ok = await postLotConsume(l.lot_id, take);
          if (!ok) throw new Error('lot/consume failed');

          consumed += take;
          remaining = Math.max(0, remaining - take);
          ops.push({ lot_id: l.lot_id, take, before: lotQty, after: Math.max(0, lotQty - take), best_before: l.best_before, location: l.location });

          logEvent('lot_consume', {
            lot_id: l.lot_id, product_id: pid, qty_delta: -take,
            before: lotQty, after: Math.max(0, lotQty - take),
            best_before: l.best_before, location: l.location, unit, name: productName
          });
        }

        logEvent('product_consume', {
          product_id: pid, requested_qty: qty, consumed_qty: consumed,
          remaining_to_consume: remaining, operations_count: ops.length,
          unit, name: productName
        });

        return { remaining, consumed, ops };
      }

      // bouton valider
      $validate.addEventListener('click', async () => {
        const pid = parseInt(($hiddenId.value || '0'), 10);
        const q = parseFloat((($qty.value || '').replace(',', '.')));
        if (!pid || !(q > 0)) return;
        try {
          const res = await consumeFIFO(pid, q);
          if (res.remaining > 0) {
            (window.showToast || (m => alert(m)))(`Partiel : consommé ${res.consumed}/${q}`, 'warn');
          } else {
            (window.showToast || (m => alert(m)))('Consommé ' + res.consumed, 'ok');
          }
          $qty.value = '';
          const info = await fetchProductInfo(pid);
          fillInfos(info);
        } catch (e) {
          err('consume click failed', e);
          (window.showToast || (m => alert(m)))('Consommation impossible', 'error');
        }
      });

      // listeners métier : on ne fetch pas à chaque frappe (seulement change/blur)
      ['change', 'blur'].forEach(evt => $input.addEventListener(evt, onProductChanged));
      $btns.forEach(b => b.addEventListener('click', onQuickBtn));
      $qty.addEventListener('input', updateValidateState);
      $qty.addEventListener('change', updateValidateState);

      // helpers debug
      function updateDebugLink(pid) {
        if (!$debugRow || !$jsonLink) return;
        if (pid) {
          const url = makeIngressUrl('api/product-info', { product_id: String(pid) });
          $jsonLink.href = url;
          if ($jsonMeta) $jsonMeta.textContent = ` (product_id=${pid})`;
          $debugRow.style.display = '';
        } else {
          $jsonLink.removeAttribute('href');
          if ($jsonMeta) $jsonMeta.textContent = '';
          $debugRow.style.display = 'none';
        }
      }
    })();
  </script>


  <!-- ===================== À consommer en priorité (Top 8) ===================== -->
  <div class="card">
    <div class="title">
      <h2>À consommer en priorité (Top 8)</h2>
    </div>

    {% set urgents = lots
    | selectattr('status', 'defined')
    | selectattr('status', 'in', ['red', 'yellow'])
    | list %}

    <!-- Desktop -->
    <div class="top8-table table-responsive">
      <table>
        <thead>
          <tr>
            <th>Produit</th>
            <th>Emp.</th>
            <th>Qté</th>
            <th>DLC</th>
            <th>État</th>
          </tr>
        </thead>
        <tbody>
          {% if urgents|length > 0 %}
          {% for it in urgents[:8] %}
          <tr>
            <td>{{ it.product }}</td>
            <td class="muted">{{ it.location }}</td>
            <td>{{ '%.2f'|format(it.qty)|trim('0')|trim('.') }} {{ it.unit|pluralize_fr(it.qty) }}</td>
            <td>{{ it.best_before or '—' }}</td>
            <td>
              {% if it.status == 'red' %}
              <span class="pill danger">Urgent</span>
              {% elif it.status == 'yellow' %}
              <span class="pill warn">Bientôt</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="5" class="muted">Aucun produit urgent ou bientôt à consommer.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div><!-- /.top8-table -->

    <!-- Mobile -->
    <div class="top8-cards">
      {% if urgents|length > 0 %}
      {% for it in urgents[:8] %}
      <div class="lot-card">
        <div class="lot-main">
          <div class="lot-title">{{ it.product }}</div>
          <div class="lot-meta">
            <span>📍 {{ it.location }}</span>
            <span>⚖️ {{ '%.2f'|format(it.qty)|trim('0')|trim('.') }} {{ it.unit|pluralize_fr(it.qty) }}</span>
            <span>🗓️ {{ it.best_before or '—' }}</span>
            <span>
              {% if it.status == 'red' %}
              <span class="pill danger">Urgent</span>
              {% elif it.status == 'yellow' %}
              <span class="pill warn">Bientôt</span>
              {% endif %}
            </span>
          </div>
        </div>
      </div><!-- /.lot-card -->
      {% endfor %}
      {% else %}
      <div class="muted">Aucun produit urgent ou bientôt à consommer.</div>
      {% endif %}
    </div><!-- /.top8-cards -->
  </div><!-- /.card (À consommer en priorité) -->

  <!-- ===================== Produits en faible stock (Top 8) ===================== -->
  <div class="card">
    <div class="title">
      <h2>Produits en faible stock (Top 8)</h2>
    </div>

    <!-- Desktop -->
    <div class="top8-table table-responsive">
      <table>
        <thead>
          <tr>
            <th>Produit</th>
            <th>Stock total</th>
            <th>Seuil min</th>
            <th>Manque</th>
          </tr>
        </thead>
        <tbody>
          {% set ns = namespace(count=0) %}
          {% for p in low_products %}
          {# NOTE: je force des nombres fiables (float) pour éviter les surprises d’affichage #}
          {% set q = (p.qty_total if p.qty_total is defined else 0) | float %}
          {% set minq = (p.min_qty if p.min_qty is defined else 0) | float %}
          {% set manque = (minq - q) if minq > q else 0 %}
          {% if manque > 0 and ns.count < 8 %} {% set ns.count=ns.count + 1 %} <tr>
            <td>{{ p.name }}</td>
            <td>
              {% if q == 0 %}
              0 {{ p.unit|pluralize_fr(0) if p.unit is defined else '' }}
              {% else %}
              {{ ('%.2f' % q) | trim('0') | trim('.') }} {{ p.unit|pluralize_fr(q) if p.unit is defined else '' }}
              {% endif %}
            </td>
            <td>{{ (minq|int if minq == minq|int else (('%.2f' % minq)|trim('0')|trim('.'))) }}</td>
            <td>{{ manque|int }} {{ p.unit|pluralize_fr(manque) if p.unit is defined else '' }}</td>
            </tr>
            {% endif %}
            {% endfor %}
            {% if ns.count == 0 %}
            <tr>
              <td colspan="4" class="muted">
                Aucun produit en dessous du seuil.
              </td>
            </tr>
            {% endif %}
        </tbody>
      </table>
    </div><!-- /.top8-table -->

    <!-- Mobile -->
    <div class="top8-cards">
      {% set ns = namespace(count=0) %}
      {% for p in low_products %}
      {% set q = (p.qty_total if p.qty_total is defined else 0) | float %}
      {% set minq = (p.min_qty if p.min_qty is defined else 0) | float %}
      {% set manque = (minq - q) if minq > q else 0 %}
      {% if manque > 0 and ns.count < 8 %} {% set ns.count=ns.count + 1 %} <div class="lot-card">
        <div class="lot-main">
          <div class="lot-title">{{ p.name }}</div>
          <div class="lot-meta">
            <span>
              ⚖️
              {% if q == 0 %}
              0 {{ p.unit|pluralize_fr(0) if p.unit is defined else '' }}
              {% else %}
              {{ ('%.2f' % q) | trim('0') | trim('.') }} {{ p.unit|pluralize_fr(q) if p.unit is defined else '' }}
              {% endif %}
            </span>
            <span>🎯 Seuil : {{ (minq|int if minq == minq|int else (('%.2f' % minq)|trim('0')|trim('.'))) }}</span>
            <span>⛽ Manque : {{ manque|int }} {{ p.unit|pluralize_fr(manque) if p.unit is defined else '' }}</span>
          </div>
        </div>
    </div><!-- /.lot-card -->
    {% endif %}
    {% endfor %}

    {% if ns.count == 0 %}
    <div class="muted">
      Aucun produit en dessous du seuil.
    </div>
    {% endif %}
  </div><!-- /.top8-cards -->
</div><!-- /.card (faible stock) -->

</div><!-- /.wrap -->
{% endblock %}