<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Domovra{% endblock %}</title>

  <!-- Source de vérité côté UI -->
  <meta name="domovra:theme" content="{{ SETTINGS.theme|default('auto') }}">
  <meta name="domovra:sidebar" content="{{ '1' if SETTINGS.sidebar_compact else '0' }}">
  <meta name="domovra:toastDuration" content="{{ SETTINGS.toast_duration|default(3000) }}">

  <!-- Override des couleurs de toasts depuis les paramètres -->
  <style>
    :root {
      --toast-ok: {
          {
          SETTINGS.toast_ok|default('#4caf50')
        }
      }

      ;

      --toast-warn: {
          {
          SETTINGS.toast_warn|default('#ffb300')
        }
      }

      ;

      --toast-error: {
          {
          SETTINGS.toast_error|default('#ef5350')
        }
      }

      ;
    }
  </style>

  <script>
    (function () {
      const mTheme = document.querySelector('meta[name="domovra:theme"]');
      const mSide = document.querySelector('meta[name="domovra:sidebar"]');
      const pref = (mTheme && mTheme.content) || 'auto';
      const html = document.documentElement;
      function setTheme(mode) {
        if (!html) return;
        if (mode === 'light' || mode === 'dark') {
          html.setAttribute('data-theme', mode);
          html.style.colorScheme = mode;
          try { localStorage.setItem('domovra_theme', mode); } catch (e) { }
        } else {
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          html.setAttribute('data-theme', isDark ? 'dark' : 'light');
          html.style.colorScheme = isDark ? 'dark' : 'light';
        }
      }
      if (pref === 'light' || pref === 'dark') setTheme(pref);
      else {
        let saved = null;
        try { saved = localStorage.getItem('domovra_theme'); } catch (e) { }
        setTheme((saved === 'light' || saved === 'dark') ? saved : 'auto');
      }
      try {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener?.('change', () => {
          const now = (mTheme && mTheme.content) || 'auto';
          if (now === 'auto') setTheme('auto');
        });
      } catch (e) { }
      const mini = (mSide && mSide.content === '1');
      if (mini) html.classList.add('sidebar-mini'); else html.classList.remove('sidebar-mini');
    })();
  </script>

  <!-- Précharge la CSS ; si préload annulé par le navigateur, le <link> normal prend le relai -->
  <link rel="preload" href="{{ BASE }}{{ ASSET_CSS_PATH }}" as="style">
  <link rel="stylesheet" href="{{ BASE }}{{ ASSET_CSS_PATH }}">

  {% block head %}{% endblock %}
</head>

<body>
  <div class="layout">
    <aside>
      <nav class="menu">
        <a href="{{ BASE }}" class="{% if request.path == BASE %}active{% endif %}"><span
            class="ico">🏠</span><span>Accueil</span></a>
        <a href="{{ BASE }}products" class="{% if request.path.startswith(BASE ~ 'products')  %}active{% endif %}"><span
            class="ico">📦</span><span>Fiche produit</span></a>
        <a href="{{ BASE }}shopping" class="{% if request.path.startswith(BASE ~ 'shopping') %}active{% endif %}">
          <span class="ico">🧾</span><span>🚧Liste de courses🚧</span>
        </a>
        <a href="{{ BASE }}achats" class="{% if request.path.startswith(BASE ~ 'achats') %}active{% endif %}">
          <span class="ico">🛒</span><span>Achats</span></a>
        <a href="{{ BASE }}lots" class="{% if request.path.startswith(BASE ~ 'lots')       %}active{% endif %}"><span
            class="ico">🧮</span><span>Mon stocks</span></a>
        <a href="{{ BASE }}settings"
          class="{% if request.path.startswith(BASE ~ 'settings')   %}active{% endif %}"><span
            class="ico">⚙️</span><span>🚧Paramètres🚧</span></a>
        <a href="{{ BASE }}support" class="{% if request.path.startswith(BASE ~ 'support')    %}active{% endif %}"><span
            class="ico">☕</span><span>Support</span></a>
      </nav>
    </aside>

    <main>
      <header>
        <div class="header-left">
          <button class="hamburger" id="hamburger" aria-label="Ouvrir le menu"
            aria-expanded="false"><span></span><span></span><span></span></button>
          {% set seg = request.path.replace(BASE, '').strip('/') %}
          <h1 class="app-title">
            Domovra —
            {% if seg == '' %}Accueil
            {% elif seg.startswith('products') %}Produits
            {% elif seg.startswith('locations') %}Emplacements
            {% elif seg.startswith('lots') %}Stocks
            {% elif seg.startswith('settings') %}Paramètres
            {% elif seg.startswith('journal') %}Journal
            {% elif seg.startswith('support') %}Support
            {% elif seg.startswith('shopping') %}Liste de courses
            {% else %}{{ seg|replace('-', ' ')|capitalize }}{% endif %}
          </h1>
        </div>

        <div class="header-right">
          <div class="header-chips">
            {% if products is defined and lots is defined %}
            {% set soon = lots|selectattr('status','equalto','yellow')|list %}
            {% set urg = lots|selectattr('status','equalto','red')|list %}
            <span class="chip">📦 Produits : <b>{{ products|length }}</b></span>
            <span class="chip">🧊 Stocks : <b>{{ lots|length }}</b></span>
            <span class="chip">⏰ Bientôt : <b>{{ soon|length }}</b></span>
            <span class="chip">⚠️ Urgents : <b>{{ urg|length }}</b></span>
            {% endif %}
            {% block header_right %}{% endblock %}
          </div>
        </div>
      </header>

      <section class="page">
        {% block content %}{% endblock %}
      </section>
    </main>
  </div>

  <!-- TOASTS -->
  <div id="toast-stack" class="toast-stack" aria-live="polite"></div>

  <!-- JS : sidebar mobile + toasts (inchangé) -->
  <script>
    (function () {
      const btn = document.getElementById('hamburger');
      if (!btn) return;
      const isMobile = () => matchMedia('(max-width:1024px)').matches;
      const open = () => { document.body.classList.add('sidebar-open'); btn.setAttribute('aria-expanded', 'true'); };
      const close = () => { document.body.classList.remove('sidebar-open'); btn.setAttribute('aria-expanded', 'false'); };
      btn.addEventListener('click', () => (document.body.classList.contains('sidebar-open') ? close() : open()));
      addEventListener('resize', () => { if (!isMobile()) close(); });
      document.querySelector('aside')?.addEventListener('click', (e) => {
        const a = e.target.closest('a'); if (a && isMobile()) close();
      });
    })();

    (function () {
      const stack = document.getElementById('toast-stack');
      const mDur = document.querySelector('meta[name="domovra:toastDuration"]');
      const defaultDuration = mDur ? (parseInt(mDur.content || '3000', 10) || 3000) : 3000;

      const cssVar = (name) =>
        getComputedStyle(document.documentElement).getPropertyValue(name).trim();

      function hexToRgba(hex, a) {
        if (!hex) return '';
        let h = hex.replace('#', '').trim();
        if (h.length === 3) h = h.split('').map(x => x + x).join('');
        const r = parseInt(h.slice(0, 2), 16);
        const g = parseInt(h.slice(2, 4), 16);
        const b = parseInt(h.slice(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${a})`;
      }

      function colorFor(type) {
        if (type === 'warn') return cssVar('--toast-warn') || '#ffb300';
        if (type === 'error') return cssVar('--toast-error') || '#ef5350';
        return cssVar('--toast-ok') || '#4caf50';
      }

      function showToast(msg, type = 'ok', timeout) {
        if (!stack) return;
        const el = document.createElement('div');
        el.className = 'toast ' + (type || 'ok');
        el.textContent = msg;

        const stripe = document.createElement('i');
        stripe.className = 'stripe';
        const col = colorFor(type);
        stripe.style.backgroundColor = col;
        el.appendChild(stripe);

        el.style.backgroundColor = hexToRgba(col, 0.10);

        stack.appendChild(el);

        const hide = () => {
          el.style.transition = '200ms ease';
          el.style.opacity = '0';
          el.style.transform = 'translateY(-4px)';
          setTimeout(() => el.remove(), 200);
        };
        const t = setTimeout(hide, timeout ?? defaultDuration);
        el.addEventListener('click', () => { clearTimeout(t); hide(); });
      }

      window.showToast = showToast;
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>

</html>